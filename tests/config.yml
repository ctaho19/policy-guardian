pipeline:
  name: pl_automated_monitoring_CTRL_1077231
  use_test_data_on_nonprod: false
  dq_strict_mode: false

stages:
  extract:
    thresholds_raw:
      connector: snowflake
      options:
        sql: "@text:sql/monitoring_thresholds.sql"

  transform:
    monitoring_metrics:
      function: custom/calculate_ctrl1077231_metrics
      options:
        thresholds_raw: $thresholds_raw
        resource_type: AWS::EC2::Instance
        config_key: metadataOptions.httpTokens
        config_value: required
        ctrl_id: CTRL-1077231
        tier1_metric_id: 1
        tier2_metric_id: 2

  load:
    monitoring_metrics:
      connector: onestream
      options:
        table_name: etip_controls_monitoring_metrics
        file_type: AVRO
        avro_schema: "@json:avro_schema.json"
        business_application: BAENTERPRISETECHINSIGHTS

tags:
  - automated_monitoring
  - controls
  - ctrl_1077231
  - cloud

ingress_validation:
  thresholds_raw:
    - type: count_check
      fatal: true
      options:
        threshold: 1
