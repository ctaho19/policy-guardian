WITH LATEST_BATCHES AS (
    -- Get latest batch IDs for both Lazer datasets
    SELECT 
        MAX(BATCH_ID) AS LAZER_BATCH_ID
    FROM CLCN_DB.PHDP_CLOUD.lazer_controls_v03
),

RESOURCE_INVENTORY AS (
    -- Get total resources from QER report
    SELECT 
        SUM(INVENTORY_COUNT) AS TOTAL_RESOURCES,
        COUNT(DISTINCT RESOURCE_TYPE) AS RESOURCE_TYPES_COUNT
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V3
    WHERE BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V3
    )
    AND CONTROL_ID = '<your_control_id>'
    AND INVENTORY_COUNT >= 0
),

NON_COMPLIANT_RESOURCES AS (
    -- Get current non-compliant resources
    SELECT 
        COUNT(DISTINCT nc.ID) AS NON_COMPLIANT_COUNT
    FROM CLCN_DB.PHDP_CLOUD.ozone_non_compliant_resource_history_v06 nc
    WHERE nc.CONTROL_ID = '<your_control_id>'
    AND nc.ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V03
    )
),

COMPLIANCE_METRICS AS (
    -- Calculate compliance metrics
    SELECT 
        ri.TOTAL_RESOURCES,
        nc.NON_COMPLIANT_COUNT,
        ROUND(100.0 * (ri.TOTAL_RESOURCES - nc.NON_COMPLIANT_COUNT) / 
            NULLIF(ri.TOTAL_RESOURCES, 0), 2) AS RESOURCE_COMPLIANCE_RATE
    FROM RESOURCE_INVENTORY ri
    CROSS JOIN NON_COMPLIANT_RESOURCES nc
)

SELECT 
    CURRENT_DATE AS DATE,
    'MNTR-XXXXX-T2' AS MONITORING_METRIC_NUMBER,
    RESOURCE_COMPLIANCE_RATE AS MONITORING_METRIC,
    CASE 
        WHEN RESOURCE_COMPLIANCE_RATE >= 95.0 THEN 'GREEN'
        WHEN RESOURCE_COMPLIANCE_RATE >= 90.0 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS
FROM COMPLIANCE_METRICS;
