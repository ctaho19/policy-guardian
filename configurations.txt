

-- Investigation Query to Compare Results
WITH ORIGINAL_QUERY_RESULTS AS (
    -- Simplified version of first query with key components
    WITH RANKEDRECORDS AS (
        SELECT *,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND INVENTORY_COUNT >= 0
    )
    SELECT 
        'Original Query' as QUERY_SOURCE,
        SUM(INVENTORY_COUNT) AS TOTAL_RESOURCES,
        SUM(EVALUATED_COUNT) AS EVALUATED_RESOURCES
    FROM RANKEDRECORDS 
    WHERE RANK = 1
    AND CONTROL_ID = 'control_id'
),
TESTING_QUERY_RESULTS AS (
    -- Second query that gives correct evaluated resources
    SELECT 
        'Testing Query' as QUERY_SOURCE,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATED_COUNT) AS EVALUATED_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE RESOURCE_TYPE = 'AWS::IAM:ROLE'
    AND ROLE_TYPE = 'MACHINE'
    AND BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND SD_LOAD_TIMESTAMP >= '2024-12-18'
    AND CONTROL_ID = 'control_id'
),
DETAILED_COMPARISON AS (
    -- Get detailed breakdown of what might be missing
    SELECT 
        ACCOUNT_NUMBER,
        REGION,
        ASV,
        RESOURCE_TYPE,
        ROLE_TYPE,
        INVENTORY_COUNT,
        EVALUATED_COUNT,
        TOTAL_EVALUATED_COUNT,
        SD_LOAD_TIMESTAMP,
        ROW_NUMBER() OVER (
            PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
            ORDER BY BATCH_ID DESC
        ) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND CONTROL_ID = 'control_id'
)

-- Compare the results
SELECT * FROM (
    SELECT * FROM ORIGINAL_QUERY_RESULTS
    UNION ALL
    SELECT * FROM TESTING_QUERY_RESULTS
)
ORDER BY QUERY_SOURCE;

-- Analyze potential missing records
SELECT 
    'Missing or Different Records' as ANALYSIS_TYPE,
    COUNT(*) as RECORD_COUNT,
    SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
    SUM(EVALUATED_COUNT) as EVALUATED_COUNT,
    SUM(TOTAL_EVALUATED_COUNT) as TOTAL_EVALUATED_COUNT
FROM DETAILED_COMPARISON
WHERE RANK = 1
AND (
    RESOURCE_TYPE != 'AWS::IAM:ROLE'
    OR ROLE_TYPE != 'MACHINE'
    OR SD_LOAD_TIMESTAMP < '2024-12-18'
);
