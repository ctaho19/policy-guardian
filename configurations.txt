WITH RoleClassification AS (
    SELECT 
        ROLE_TYPE,
        ASV,
        ACCOUNT_NUMBER,
        REGION,
        INVENTORY_COUNT,
        TOTAL_EVALUATIONS_COUNT,
        ROUND(TOTAL_EVALUATIONS_COUNT * 100.0 / NULLIF(INVENTORY_COUNT, 0), 2) as COVERAGE_PERCENTAGE,
        ROW_NUMBER() OVER (PARTITION BY ASV ORDER BY INVENTORY_COUNT DESC) as INV_RANK
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
)
SELECT 
    ASV,
    STRING_AGG(DISTINCT ROLE_TYPE, ', ') as ROLE_TYPES,
    COUNT(DISTINCT ROLE_TYPE) as NUM_ROLE_TYPES,
    COUNT(DISTINCT ACCOUNT_NUMBER) as NUM_ACCOUNTS,
    SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
    ROUND(AVG(COVERAGE_PERCENTAGE), 2) as AVG_COVERAGE
FROM RoleClassification
GROUP BY ASV
HAVING COUNT(DISTINCT ROLE_TYPE) > 1  -- ASVs with multiple role types
ORDER BY TOTAL_INVENTORY DESC;

Are there ASVs that appear under both N/A and other role types?
For ASVs with multiple role types, how does the coverage compare?
Are the high-inventory, low-coverage cases we found earlier showing up with multiple role classifications?
