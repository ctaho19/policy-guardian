
WITH LAST_SCAN_DATE AS (
    SELECT MAX(METRIC_DATE) AS RECENT_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE METRIC_DATE BETWEEN DATEADD(DAY, -3, CURRENT_DATE) AND DATEADD(DAY, -2, CURRENT_DATE())
)
SELECT LSD.RECENT_DATE AS DATE,
    'MNTR-1079134-T0' AS MONITORING_METRIC_NUMBER,
    COALESCE(CASE 
        WHEN LSD.RECENT_DATE = DATEADD(DAY, -2, CURRENT_DATE()) 
            AND SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) > 0 THEN 1
        ELSE 0 
    END, 0) AS MONITORING_METRIC,
    COALESCE(CASE 
        WHEN LSD.RECENT_DATE = DATEADD(DAY, -2, CURRENT_DATE()) 
            AND SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) > 0 THEN 'GREEN'
        ELSE 'RED' 
    END, 'RED') AS COMPLIANCE_STATUS
FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV
RIGHT JOIN LAST_SCAN_DATE LSD ON MMV.METRIC_DATE = LSD.RECENT_DATE
GROUP BY LSD.RECENT_DATE;
