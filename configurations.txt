WITH ASVComparison AS (
    SELECT 
        ASV,
        ROLE_TYPE,
        REGION,
        COUNT(*) as RESOURCE_COUNT,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ASV IN ('ASVCLOUDCI', 'ASVWANDA', 'ASVNEWREL', 'ASVCOEPCL', 'ASVCLOUDJA', 'ASVXXX')
    ) a
    WHERE rank = 1
    GROUP BY ASV, ROLE_TYPE, REGION
)
SELECT *
FROM ASVComparison
ORDER BY ASV, COVERAGE_PERCENTAGE ASC;

Could you run this and tell me:
Do these ASVs have better coverage when they're not machine roles?
Do they have better coverage in non-global regions?
Is the inventory-to-evaluation ratio consistent across all instances of these ASVs?


