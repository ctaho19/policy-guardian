WITH LATEST_SCAN_INFO AS (
    -- Get the most recent scan info based on SF_LOAD_TIMESTAMP for Tier 0 & 1
    SELECT 
        METRIC_DATE,
        SF_LOAD_TIMESTAMP,
        CASE 
            WHEN DATE(SF_LOAD_TIMESTAMP) >= DATEADD(DAY, -1, CURRENT_DATE()) THEN TRUE 
            ELSE FALSE 
        END AS IS_CURRENT,
        TOTAL_BUCKETS_SCANNED_BY_MACIE,
        TOTAL_CLOUDFRONTED_BUCKETS
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE SF_LOAD_TIMESTAMP = (
        SELECT MAX(SF_LOAD_TIMESTAMP) 
        FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    )
),
TIER2_SUMMARY AS (
    -- Calculate test results for current date
    SELECT
        COUNT(*) AS TOTAL_TESTS,
        SUM(CASE WHEN TESTISSUCCESSFUL = TRUE THEN 1 ELSE 0 END) AS TOTAL_SUCCESSFUL_TESTS
    FROM CYBR_DB.PHDP_CYBR.MACIE_CONTROLS_TESTING
    WHERE REPORTDATE = CURRENT_DATE()
),
HISTORICAL_DATA AS (
    -- Get historical test statistics for anomaly detection
    SELECT
        AVG(TOTAL_TESTS) AS AVG_HISTORICAL_TESTS,
        MIN(TOTAL_TESTS) AS MIN_HISTORICAL_TESTS,
        MAX(TOTAL_TESTS) AS MAX_HISTORICAL_TESTS
    FROM (
        SELECT REPORTDATE, COUNT(*) AS TOTAL_TESTS
        FROM CYBR_DB.PHDP_CYBR.MACIE_CONTROLS_TESTING
        WHERE REPORTDATE BETWEEN DATEADD(DAY, -14, CURRENT_DATE()) AND DATEADD(DAY, -1, CURRENT_DATE())
        GROUP BY REPORTDATE
    ) DAILY_TESTS
)

-- Combine all three tiers
SELECT * FROM (
    -- Tier 0 Metric
    SELECT 
        CURRENT_DATE() AS DATE,
        'MNTR-1079134-T0' AS MONITORING_METRIC_NUMBER,
        CASE 
            WHEN IS_CURRENT = TRUE AND TOTAL_BUCKETS_SCANNED_BY_MACIE > 0 THEN 100
            ELSE 0
        END AS MONITORING_METRIC,
        CASE 
            WHEN IS_CURRENT = TRUE AND TOTAL_BUCKETS_SCANNED_BY_MACIE > 0 THEN 'GREEN'
            ELSE 'RED'
        END AS COMPLIANCE_STATUS,
        TOTAL_BUCKETS_SCANNED_BY_MACIE AS NUMERATOR,
        1 AS DENOMINATOR
    FROM LATEST_SCAN_INFO

    UNION ALL

    -- Tier 1 Metric
    SELECT
        CURRENT_DATE() AS DATE,
        'MNTR-1079134-T1' AS MONITORING_METRIC_NUMBER,
        CASE 
            WHEN IS_CURRENT THEN 
                ROUND(100.0 * TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0), 2)
            ELSE 0
        END AS MONITORING_METRIC,
        CASE 
            WHEN NOT IS_CURRENT THEN 'RED'
            WHEN (TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0)) >= 0.9 THEN 'GREEN'
            WHEN (TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0)) >= 0.8 THEN 'YELLOW'
            ELSE 'RED'
        END AS COMPLIANCE_STATUS,
        TOTAL_BUCKETS_SCANNED_BY_MACIE AS NUMERATOR,
        TOTAL_CLOUDFRONTED_BUCKETS AS DENOMINATOR
    FROM LATEST_SCAN_INFO

    UNION ALL

    -- Tier 2 Metric
    SELECT
        CURRENT_DATE() AS DATE,
        'MNTR-1079134-T2' AS MONITORING_METRIC_NUMBER,
        ROUND(100.00 * TOTAL_SUCCESSFUL_TESTS / NULLIF(TOTAL_TESTS, 0), 2) AS MONITORING_METRIC,
        CASE 
            WHEN TOTAL_TESTS = 0 THEN NULL
            WHEN TOTAL_SUCCESSFUL_TESTS = TOTAL_TESTS THEN 'GREEN'
            WHEN TOTAL_SUCCESSFUL_TESTS = 0 THEN 'RED'
            WHEN TOTAL_TESTS < (SELECT MIN_HISTORICAL_TESTS FROM HISTORICAL_DATA)
              OR TOTAL_TESTS > (SELECT MAX_HISTORICAL_TESTS FROM HISTORICAL_DATA)
              OR ABS(TOTAL_TESTS - (SELECT AVG_HISTORICAL_TESTS FROM HISTORICAL_DATA)) 
                 > (SELECT AVG_HISTORICAL_TESTS FROM HISTORICAL_DATA) * 0.2
            THEN 'YELLOW'
            ELSE 'GREEN'
        END AS COMPLIANCE_STATUS,
        TOTAL_SUCCESSFUL_TESTS AS NUMERATOR,
        TOTAL_TESTS AS DENOMINATOR
    FROM TIER2_SUMMARY
)
ORDER BY MONITORING_METRIC_NUMBER;
