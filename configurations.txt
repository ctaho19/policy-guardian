SELECT 
    REGION,
    ASV,
    COUNT(*) as TOTAL_RESOURCES,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
    SUM(INVENTORY_COUNT) as INVENTORY_COUNT,
    ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE
FROM (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 TC
    WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND CLOUD_PROVIDER = 'AWS'
    AND ROLE_TYPE = 'MACHINE'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND INVENTORY_COUNT > 0
    AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
) RankedRecords
WHERE RankedRecords.rank = 1
GROUP BY REGION, ASV
HAVING SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0) < 80
ORDER BY COVERAGE_PERCENTAGE ASC;
