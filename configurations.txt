
WITH LATEST_SCAN_DATE AS (
    SELECT MAX(METRIC_DATE) AS MOST_RECENT_SCAN_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
),
METRIC_CALCULATION AS (
    SELECT
        CURRENT_DATE() AS DATE,  -- Changed to always use current date
        LSD.MOST_RECENT_SCAN_DATE,
        SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) AS NUMERATOR,
        SUM(TOTAL_CLOUDFRONTED_BUCKETS) AS DENOMINATOR,
        -- Only calculate metric if dates match
        CASE 
            WHEN LSD.MOST_RECENT_SCAN_DATE = CURRENT_DATE() THEN
                COALESCE(
                    CAST(SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) AS FLOAT) /
                    NULLIF(CAST(SUM(TOTAL_CLOUDFRONTED_BUCKETS) AS FLOAT), 0),
                    0
                )
            ELSE 0
        END AS TIER_1_METRIC,
        CASE 
            WHEN LSD.MOST_RECENT_SCAN_DATE = CURRENT_DATE() THEN TRUE 
            ELSE FALSE 
        END AS IS_CURRENT
    FROM LATEST_SCAN_DATE LSD
    LEFT JOIN CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV 
        ON MMV.METRIC_DATE = LSD.MOST_RECENT_SCAN_DATE
    GROUP BY 
        LSD.MOST_RECENT_SCAN_DATE,
        CURRENT_DATE()
)
SELECT
    DATE,
    'MNTR-1079134-T1' AS MONITORING_METRIC_NUMBER,
    ROUND(TIER_1_METRIC * 100, 2) AS MONITORING_METRIC,
    CASE 
        WHEN NOT IS_CURRENT THEN 'RED'
        WHEN TIER_1_METRIC >= 0.9 THEN 'GREEN'
        WHEN TIER_1_METRIC >= 0.8 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    NUMERATOR,
    DENOMINATOR
FROM METRIC_CALCULATION;
