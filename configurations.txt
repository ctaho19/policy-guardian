WITH RESOURCE_COUNTS AS (
    SELECT 
        CONTROL_ID,
        SUM(INVENTORY_COUNT) AS TOTAL_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    )
    AND INVENTORY_COUNT >= 0
    GROUP BY CONTROL_ID
),
NON_COMPLIANT_COUNTS AS (
    SELECT 
        CONTROL_ID,
        COUNT(DISTINCT ID) AS NON_COMPLIANT_COUNT
    FROM CLCN_DB.PHDP_CLOUD.ozone_non_compliant_resource_history_v07_v02
    WHERE ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
    )
    GROUP BY CONTROL_ID
)
SELECT 
    rc.CONTROL_ID,
    rc.TOTAL_RESOURCES,
    nc.NON_COMPLIANT_COUNT,
    CASE 
        WHEN nc.NON_COMPLIANT_COUNT > rc.TOTAL_RESOURCES THEN 'MISMATCH'
        ELSE 'OK'
    END AS STATUS,
    nc.NON_COMPLIANT_COUNT - rc.TOTAL_RESOURCES AS DIFFERENCE
FROM RESOURCE_COUNTS rc
LEFT JOIN NON_COMPLIANT_COUNTS nc ON rc.CONTROL_ID = nc.CONTROL_ID
WHERE nc.NON_COMPLIANT_COUNT > rc.TOTAL_RESOURCES
OR rc.TOTAL_RESOURCES IS NULL 
OR nc.NON_COMPLIANT_COUNT IS NULL
ORDER BY DIFFERENCE DESC;
