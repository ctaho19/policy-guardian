-- Query to analyze coverage metrics across different role types
WITH RoleTypeStats AS (
    -- Calculate aggregated metrics for each role type
    SELECT 
        ROLE_TYPE,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS
    FROM (
        -- Get the most recent record for each unique resource
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                                 ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'  -- Filter for IAM roles only
        AND INVENTORY_COUNT > 0  -- Exclude resources with no inventory
    ) a
    WHERE rank = 1  -- Take only the most recent record
    GROUP BY ROLE_TYPE
)
-- Calculate final metrics including coverage percentage
SELECT 
    ROLE_TYPE,
    TOTAL_INVENTORY,
    TOTAL_EVALUATIONS,
    -- Calculate coverage as a percentage, handling division by zero
    ROUND(TOTAL_EVALUATIONS * 100.0 / NULLIF(TOTAL_INVENTORY, 0), 2) as COVERAGE_PERCENTAGE
FROM RoleTypeStats
ORDER BY COVERAGE_PERCENTAGE DESC;


-- Query to compare coverage between MACHINE and N/A roles within each ASV
WITH ASVCoverage AS (
    -- Calculate coverage metrics for each ASV and role type combination
    SELECT 
        ASV,
        ROLE_TYPE,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        -- Calculate coverage percentage for each group
        ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE
    FROM (
        -- Get most recent records
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                                 ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE IN ('MACHINE', 'N/A')  -- Only compare these two role types
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
    GROUP BY ASV, ROLE_TYPE
)
-- Pivot the data to show MACHINE and N/A coverage side by side
SELECT 
    c1.ASV,
    -- Get MACHINE role coverage
    MAX(CASE WHEN c1.ROLE_TYPE = 'MACHINE' THEN c1.COVERAGE_PERCENTAGE END) as MACHINE_COVERAGE,
    -- Get N/A role coverage
    MAX(CASE WHEN c1.ROLE_TYPE = 'N/A' THEN c1.COVERAGE_PERCENTAGE END) as NA_COVERAGE,
    -- Calculate the difference in coverage
    MAX(CASE WHEN c1.ROLE_TYPE = 'N/A' THEN c1.COVERAGE_PERCENTAGE END) - 
    MAX(CASE WHEN c1.ROLE_TYPE = 'MACHINE' THEN c1.COVERAGE_PERCENTAGE END) as DELTA
FROM ASVCoverage c1
-- Only include ASVs where N/A roles have 100% coverage
WHERE EXISTS (
    SELECT 1 FROM ASVCoverage c2 
    WHERE c2.ASV = c1.ASV 
    AND c2.ROLE_TYPE = 'N/A'
    AND c2.COVERAGE_PERCENTAGE = 100
)
GROUP BY c1.ASV
ORDER BY DELTA DESC
LIMIT 10;


-- Query to analyze the distribution of coverage across different ranges for MACHINE roles
WITH MachineRoleStats AS (
    -- Calculate coverage metrics for each unique combination
    SELECT 
        ACCOUNT_NUMBER,
        ASV,
        REGION,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        SUM(INVENTORY_COUNT) as INVENTORY_COUNT,
        -- Calculate coverage percentage
        ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE
    FROM (
        -- Get most recent records
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                                 ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE = 'MACHINE'
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
    GROUP BY ACCOUNT_NUMBER, ASV, REGION
)
-- Group the results into coverage ranges
SELECT 
    -- Define coverage ranges
    CASE 
        WHEN COVERAGE_PERCENTAGE < 20 THEN '0-20%'
        WHEN COVERAGE_PERCENTAGE < 40 THEN '20-40%'
        WHEN COVERAGE_PERCENTAGE < 60 THEN '40-60%'
        WHEN COVERAGE_PERCENTAGE < 80 THEN '60-80%'
        ELSE '80-100%'
    END as COVERAGE_RANGE,
    COUNT(*) as COUNT,  -- Number of resources in each range
    SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,  -- Total inventory in each range
    ROUND(AVG(COVERAGE_PERCENTAGE), 2) as AVG_COVERAGE  -- Average coverage in each range
FROM MachineRoleStats
GROUP BY 
    CASE 
        WHEN COVERAGE_PERCENTAGE < 20 THEN '0-20%'
        WHEN COVERAGE_PERCENTAGE < 40 THEN '20-40%'
        WHEN COVERAGE_PERCENTAGE < 60 THEN '40-60%'
        WHEN COVERAGE_PERCENTAGE < 80 THEN '60-80%'
        ELSE '80-100%'
    END
ORDER BY COVERAGE_RANGE;
