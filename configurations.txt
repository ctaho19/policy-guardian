SELECT DISTINCT RESOURCE_TYPE 
FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
    USING (CLOUD_CONTROL_ID, BATCH_ID)
WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03)
AND ESCALATING
AND PHASE = 'OPERATIONAL'
AND RESOURCE_TYPE = 'AWS::IAM::Role';

WITH LATEST_BATCH AS (
    SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
)
SELECT COUNT(*), SUM(INVENTORY_COUNT), SUM(TOTAL_EVALUATIONS_COUNT)
FROM (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT * FROM LATEST_BATCH)
    AND CLOUD_PROVIDER = 'AWS'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND ROLE_TYPE = 'MACHINE'
    AND INVENTORY_COUNT > 0
    AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
) a
WHERE rank = 1;


3. Let's also verify the join condition between LAZER tables:

```sql
SELECT COUNT(DISTINCT CLOUD_CONTROL_ID)
FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
    USING (CLOUD_CONTROL_ID, BATCH_ID)
WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03);
```

