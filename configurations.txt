-- Diagnostic query using ROW_NUMBER() partitioning
WITH RANKEDRECORDS AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (
            PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
            ORDER BY BATCH_ID DESC
        ) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    )
    AND CONTROL_ID = 'CM-6.AWS.63.v01'
    AND RESOURCE_TYPE = 'AWS::EC2::Instance'
    AND INVENTORY_COUNT >= 0
)
SELECT 
    SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATED,
    ROUND(100.0 * SUM(TOTAL_EVALUATIONS_COUNT) / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as EVALUATION_PERCENTAGE
FROM RANKEDRECORDS 
WHERE RANK = 1;
GROUP BY 
    CONTROL_ID,
    RESOURCE_TYPE,
    ROLE_TYPE
ORDER BY TOTAL_INVENTORY DESC;
