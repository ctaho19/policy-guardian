-- Tier 3 Supporting Evidence Query
-- Purpose: Shows detailed information about compute groups that are currently in remediation
-- and their past due status. If no groups are in remediation, displays a single informative row.

-- First part: Get all certificates that are in remediation status
SELECT
    CERT.ASV AS APPLICATION_NAME,        -- Application name from the certification
    CERT.ID,                            -- Unique identifier for the certification
    CERT.CERTIFICATION_TYPE,            -- Type of certification (filtered to 'Compute Groups APR')
    TO_TIMESTAMP(CERT.CREATED_DATE) AS CREATION_DATE,  -- When the certification was created
    -- Determine the SLA status based on how many days the remediation is past due
    CASE
        WHEN REMMEDIATION_PAST_DUE_90_DAYS = 1 THEN '90 DAYS PAST DUE REMEDIATION'
        WHEN REMMEDIATION_PAST_DUE_60_DAYS = 1 THEN '60 DAYS PAST DUE REMEDIATION'
        WHEN REMMEDIATION_PAST_DUE_30_DAYS = 1 THEN '30 DAYS PAST DUE REMEDIATION'
        ELSE 'WITHIN SLA'
    END AS PAST_DUE_SLA
FROM (
    -- Subquery: Calculate past due indicators for each certification
    SELECT CERT.*,
    -- Flag if remediation is past due by 30 days
    CASE WHEN CERT.STATUS = 6 AND TIMESTAMPDIFF('DAY', TO_TIMESTAMP(CERT.TARGET_REMEDIATION_DATE), CURRENT_TIMESTAMP()) >= 30 THEN 1 ELSE 0 END AS REMMEDIATION_PAST_DUE_30_DAYS,
    -- Flag if remediation is past due by 60 days
    CASE WHEN CERT.STATUS = 6 AND TIMESTAMPDIFF('DAY', TO_TIMESTAMP(CERT.TARGET_REMEDIATION_DATE), CURRENT_TIMESTAMP()) >= 60 THEN 1 ELSE 0 END AS REMMEDIATION_PAST_DUE_60_DAYS,
    -- Flag if remediation is past due by 90 days
    CASE WHEN CERT.STATUS = 6 AND TIMESTAMPDIFF('DAY', TO_TIMESTAMP(CERT.TARGET_REMEDIATION_DATE), CURRENT_TIMESTAMP()) >= 90 THEN 1 ELSE 0 END AS REMMEDIATION_PAST_DUE_90_DAYS
    FROM eiam_db.phap_eram_11acapt.aa_microcertification cert
    -- Filter conditions:
    WHERE CERT.CERTIFICATION_TYPE = 'Compute Groups APR'                                           -- Only Compute Groups APR certifications
    AND TO_TIMESTAMP(CERT.CERTIFICATION_OPENED_DATE) >= DATEADD(YEAR, -1, CURRENT_DATE())         -- Within the last year
    AND CERT.STATUS = 6                                                                           -- Status 6 indicates in remediation
) CERT

UNION ALL

-- Second part: Display a "no remediation needed" message if no certificates are in remediation
SELECT
    NULL AS APPLICATION_NAME,
    NULL AS ID,
    NULL AS CERTIFICATION_TYPE,
    NULL AS CREATION_DATE,
    'NO COMPUTE APR GROUPS CURRENTLY IN REMEDIATION' AS PAST_DUE_SLA
WHERE NOT EXISTS (
    -- Check if any certificates exist that meet our criteria
    SELECT 1 FROM eiam_db.phap_eram_11acapt.aa_microcertification cert
    WHERE cert.CERTIFICATION_TYPE = 'Compute Groups APR'
    AND TO_TIMESTAMP(cert.CERTIFICATION_OPENED_DATE) >= DATEADD(YEAR, -1, CURRENT_DATE())
    AND cert.STATUS = 6
)

-- Order the results to show actual remediation items first, followed by the "no remediation" message if applicable
ORDER BY
    CASE WHEN APPLICATION_NAME IS NULL THEN 2 ELSE 1 END;
