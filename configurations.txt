-- Tier 3: Past SLA Non-Compliance
-- This query calculates the percentage of non-compliant resources that are within their SLA period
-- SLA thresholds: Critical: 0 days, High: 30 days, Medium: 60 days, Low: 90 days

WITH NON_COMPLIANT_COUNTS AS (
    SELECT 
        -- Count total non-compliant resources
        COUNT(DISTINCT RESOURCE_ID) as TOTAL_NON_COMPLIANT,
        -- Count resources that are past their SLA based on risk level
        COUNT(DISTINCT CASE 
            WHEN (CONTROL_RISK = 'Critical' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 0) OR
                 (CONTROL_RISK = 'High' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 30) OR
                 (CONTROL_RISK = 'Medium' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 60) OR
                 (CONTROL_RISK = 'Low' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 90)
            THEN RESOURCE_ID 
        END) as PAST_SLA_COUNT
    FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01
    WHERE CONTROL_ID = 'AC-3.AWS.30.v02'
    -- Exclude resources that have been remediated
    AND ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
    )
)
SELECT 
    CURRENT_DATE AS DATE,
    'MNTR-XXXXX-T3' AS MONITORING_METRIC_NUMBER,
    -- Calculate percentage of resources within SLA (higher is better)
    ROUND(100.0 * (1 - (CAST(PAST_SLA_COUNT AS DECIMAL(18,2)) / NULLIF(CAST(TOTAL_NON_COMPLIANT AS DECIMAL(18,2)), 0))), 2) AS MONITORING_METRIC,
    -- Determine compliance status:
    -- GREEN: 95% or more within SLA (5% or less past due)
    -- YELLOW: 90-95% within SLA (5-10% past due)
    -- RED: Less than 90% within SLA (more than 10% past due)
    CASE 
        WHEN (PAST_SLA_COUNT / NULLIF(TOTAL_NON_COMPLIANT, 0)) <= 0.05 THEN 'GREEN'
        WHEN (PAST_SLA_COUNT / NULLIF(TOTAL_NON_COMPLIANT, 0)) <= 0.10 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    TOTAL_NON_COMPLIANT - PAST_SLA_COUNT AS NUMERATOR,   -- Resources within SLA
    TOTAL_NON_COMPLIANT AS DENOMINATOR                    -- Total non-compliant resources
FROM NON_COMPLIANT_COUNTS;

-- Supporting Evidence Query for Tier 3
-- Lists all non-compliant resources that are past their SLA deadline
SELECT 
    ACCOUNT_ID,                                           -- AWS Account identifier
    REGION,                                              -- AWS Region
    RESOURCE_TYPE,                                       -- Type of AWS resource
    RESOURCE_ID,                                         -- Unique resource identifier
    CONTROL_RISK,                                        -- Risk level (Critical/High/Medium/Low)
    OPEN_DATE_UTC_TIMESTAMP,                             -- When the non-compliance was first detected
    DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) as AGING_DAYS  -- Days since detection
FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01
WHERE CONTROL_ID = 'AC-3.AWS.30.v02'
AND ID NOT IN (
    SELECT ID 
    FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
)
-- Only include resources that have exceeded their SLA based on risk level
AND (
    (CONTROL_RISK = 'Critical' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 0) OR
    (CONTROL_RISK = 'High' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 30) OR
    (CONTROL_RISK = 'Medium' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 60) OR
    (CONTROL_RISK = 'Low' AND DATEDIFF('days', OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 90)
)
ORDER BY AGING_DAYS DESC;                                -- Show oldest issues first
