
WITH LAST_SCAN_DATE AS (
    SELECT MAX(REPORTDATE) AS RECENT_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_CONTROLS_TESTING
    WHERE REPORTDATE BETWEEN DATEADD(DAY, -3, CURRENT_DATE) AND DATEADD(DAY, -1, CURRENT_DATE())
),
SUMMARY AS (
    SELECT COUNT(*) AS TOTAL_TESTS,
    SUM(CASE WHEN "TESTISSUCCESFUL" = TRUE THEN 1 ELSE 0 END) AS TOTAL_SUCCESSFUL_TESTS
    FROM CYBR_DB.PHDP_CYBR.MACIE_CONTROLS_TESTING JOIN LAST_SCAN_DATE LSD ON REPORTDATE = LSD.RECENT_DATE
),
HISTORICAL_DATA AS (
    SELECT AVG(TOTAL_TESTS) AS AVG_HISTORICAL_TESTS,
    MIN(TOTAL_TESTS) AS MIN_HISTORICAL_TESTS,
    MAX(TOTAL_TESTS) AS MAX_HISTORICAL_TESTS
    FROM (SELECT REPORTDATE, COUNT(*) AS TOTAL_TESTS FROM CYBR_DB.PHDP_CYBR.MACIE_CONTROLS_TESTING
    WHERE REPORTDATE BETWEEN DATEADD(DAY, -14, CURRENT_DATE) AND DATEADD(DAY, -1, CURRENT_DATE())
    GROUP BY REPORTDATE)
)
SELECT LSD.RECENT_DATE AS DATE,
'MNTR-1079134-T2' AS MONITORING_METRIC_NUMBER,
CASE 
    WHEN LSD.RECENT_DATE IS NULL THEN 0
    ELSE ROUND(100.00 * TOTAL_SUCCESSFUL_TESTS / TOTAL_TESTS, 2)
END AS MONITORING_METRIC,
CASE
    WHEN LSD.RECENT_DATE IS NULL THEN 'RED'
    WHEN TOTAL_TESTS = 0 THEN NULL
    WHEN TOTAL_SUCCESSFUL_TESTS = TOTAL_TESTS THEN 'GREEN'
    WHEN TOTAL_SUCCESSFUL_TESTS = 0 THEN 'RED'
    WHEN TOTAL_TESTS < (SELECT MIN_HISTORICAL_TESTS FROM HISTORICAL_DATA) OR
    TOTAL_TESTS < (SELECT MAX_HISTORICAL_TESTS FROM HISTORICAL_DATA) OR ABS(TOTAL_TESTS - (SELECT AVG_HISTORICAL_TESTS FROM HISTORICAL_DATA)) > (SELECT AVG_HISTORICAL_TESTS FROM HISTORICAL_DATA) * 0.2 THEN 'YELLOW' 
    ELSE 'GREEN'
END AS COMPLIANCE_STATUS
FROM LAST_SCAN_DATE LSD
LEFT JOIN SUMMARY ON 1=1;
