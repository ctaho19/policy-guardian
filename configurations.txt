WITH LATEST_BATCH AS (
    SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
),
VALID_RESOURCES AS (
    SELECT DISTINCT RESOURCE_TYPE
    FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
    LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
        USING (CLOUD_CONTROL_ID, BATCH_ID)
    WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03)
    AND ESCALATING
    AND PHASE = 'OPERATIONAL'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
),
RESOURCE_TOTALS AS (
    SELECT
        ACCOUNT_NUMBER,
        REGION,
        ASV,
        RESOURCE_TYPE,
        ROLE_TYPE,
        SUM(INVENTORY_COUNT) AS TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) AS EVALUATED_RESOURCES
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 TC
        INNER JOIN VALID_RESOURCES VR ON TC.RESOURCE_TYPE = VR.RESOURCE_TYPE
        WHERE BATCH_ID = (SELECT * FROM LATEST_BATCH)
        AND CLOUD_PROVIDER = 'AWS'
        AND TC.RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE = 'MACHINE'
        AND INVENTORY_COUNT > 0
        AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
    ) a
    WHERE rank = 1
    GROUP BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, ROLE_TYPE
)
SELECT 
    SUM(TOTAL_RESOURCES) AS TOTAL_RESOURCES,
    SUM(EVALUATED_RESOURCES) AS EVALUATED_RESOURCES
FROM RESOURCE_TOTALS;
