-- Tier 2: Compliance Rate (Evaluated Resources vs Non-Compliant Resources)
WITH LATEST_BATCH AS (
    SELECT MAX(BATCH_ID) AS BATCH_ID 
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
),
-- Get total evaluated resources (from Tier 1)
EVALUATED_RESOURCES AS (
    SELECT 
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATED
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT BATCH_ID FROM LATEST_BATCH)
    AND CONTROL_ID = 'AC-3.AWS.30.v02'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND ROLE_TYPE = 'MACHINE'
),
-- Get non-compliant resources count (from Tier 3 logic)
NON_COMPLIANT_COUNT AS (
    SELECT 
        COUNT(DISTINCT nc.RESOURCE_ID) as TOTAL_NON_COMPLIANT
    FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01 nc
    WHERE nc.CONTROL_ID = 'AC-3.AWS.30.v02'
    AND nc.ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
    )
),
-- Calculate final metrics
COMPLIANCE_METRICS AS (
    SELECT 
        e.TOTAL_EVALUATED as EVALUATED_RESOURCES,
        nc.TOTAL_NON_COMPLIANT as NON_COMPLIANT_RESOURCES,
        GREATEST(0, e.TOTAL_EVALUATED - nc.TOTAL_NON_COMPLIANT) as COMPLIANT_RESOURCES
    FROM EVALUATED_RESOURCES e
    CROSS JOIN NON_COMPLIANT_COUNT nc
)
SELECT 
    CURRENT_DATE AS DATE,
    'MNTR-XXXXX-T2' AS MONITORING_METRIC_NUMBER,
    -- Calculate compliance rate: (Evaluated - NonCompliant) / Evaluated
    ROUND(100.0 * COMPLIANT_RESOURCES / NULLIF(EVALUATED_RESOURCES, 0), 2) AS MONITORING_METRIC,
    CASE 
        WHEN (COMPLIANT_RESOURCES / NULLIF(EVALUATED_RESOURCES, 0)) >= 0.95 THEN 'GREEN'
        WHEN (COMPLIANT_RESOURCES / NULLIF(EVALUATED_RESOURCES, 0)) >= 0.90 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    COMPLIANT_RESOURCES AS NUMERATOR,
    EVALUATED_RESOURCES AS DENOMINATOR
FROM COMPLIANCE_METRICS;

-- Supporting Evidence Query for Tier 2
SELECT 
    nc.ACCOUNT_ID,
    nc.REGION,
    nc.RESOURCE_TYPE,
    nc.RESOURCE_ID,
    nc.CONTROL_ID,
    nc.OPEN_DATE_UTC_TIMESTAMP,
    DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) as DAYS_OPEN
FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01 nc
WHERE nc.CONTROL_ID = 'AC-3.AWS.30.v02'
AND nc.ID NOT IN (
    SELECT ID 
    FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
)
ORDER BY DAYS_OPEN DESC;
