WITH TotalCounts AS (
    SELECT 
        'ALL_ROLES' as CATEGORY,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 TC
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND INVENTORY_COUNT > 0
        AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
        AND RESOURCE_TYPE IN (
            SELECT DISTINCT RESOURCE_TYPE 
            FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
            LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
                ON LCTRL.CONTROL_ID = LCOMP.CONTROL_ID 
                AND LCTRL.BATCH_ID = LCOMP.BATCH_ID
            WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03)
            AND ESCALATING
            AND PHASE = 'OPERATIONAL'
            AND RESOURCE_TYPE NOT ILIKE ''
        )
    ) a
    WHERE rank = 1
),
DetailedRoleTypes AS (
    SELECT 
        ROLE_TYPE,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 TC
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND INVENTORY_COUNT > 0
        AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
        AND RESOURCE_TYPE IN (
            SELECT DISTINCT RESOURCE_TYPE 
            FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
            LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
                ON LCTRL.CONTROL_ID = LCOMP.CONTROL_ID 
                AND LCTRL.BATCH_ID = LCOMP.BATCH_ID
            WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03)
            AND ESCALATING
            AND PHASE = 'OPERATIONAL'
            AND RESOURCE_TYPE NOT ILIKE ''
        )
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE
)

SELECT 
    COALESCE(CATEGORY, 'ALL_ROLES') as ROLE_TYPE,
    TOTAL_INVENTORY,
    TOTAL_EVALUATIONS,
    ROUND(TOTAL_EVALUATIONS * 100.0 / NULLIF(TOTAL_INVENTORY, 0), 2) as COVERAGE_PERCENTAGE
FROM (
    SELECT * FROM TotalCounts
    UNION ALL
    SELECT 
        ROLE_TYPE as CATEGORY,
        TOTAL_INVENTORY,
        TOTAL_EVALUATIONS,
        COVERAGE_PERCENTAGE
    FROM DetailedRoleTypes
)
ORDER BY ROLE_TYPE;
