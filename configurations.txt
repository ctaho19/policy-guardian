-- Diagnostic Query with exact values
WITH CORRECT_BASE AS (
    SELECT 
        'CORRECT_BASE' as SOURCE,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND CONTROL_ID = 'AC-3.AWS.30.v02'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND ROLE_TYPE = 'MACHINE'
),
CURRENT_RANKED AS (
    SELECT 
        'CURRENT_RANKED' as SOURCE,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
    FROM (
        SELECT *,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CONTROL_ID = 'AC-3.AWS.30.v02'
    ) r
    WHERE RANK = 1
),
PROPOSED_RANKED AS (
    SELECT 
        'PROPOSED_RANKED' as SOURCE,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
    FROM (
        SELECT *,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, ROLE_TYPE
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CONTROL_ID = 'AC-3.AWS.30.v02'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE = 'MACHINE'
    ) r
    WHERE RANK = 1
);

-- Show results from all three approaches
SELECT * FROM CORRECT_BASE
UNION ALL
SELECT * FROM CURRENT_RANKED
UNION ALL
SELECT * FROM PROPOSED_RANKED;

-- Detailed analysis of potential duplicates
SELECT 
    ACCOUNT_NUMBER,
    REGION,
    ASV,
    RESOURCE_TYPE,
    ROLE_TYPE,
    COUNT(*) as RECORD_COUNT,
    SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
    SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
AND CONTROL_ID = 'AC-3.AWS.30.v02'
AND RESOURCE_TYPE = 'AWS::IAM::Role'
GROUP BY 
    ACCOUNT_NUMBER,
    REGION,
    ASV,
    RESOURCE_TYPE,
    ROLE_TYPE
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC
LIMIT 10;
