WITH RoleComparison AS (
    SELECT 
        ROLE_TYPE,
        ASV,
        ACCOUNT_NUMBER,
        COUNT(DISTINCT RESOURCE_ID) as UNIQUE_RESOURCES,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        COUNT(*) as ROW_COUNT
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, RESOURCE_ID ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE IN ('MACHINE', 'N/A')
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE, ASV, ACCOUNT_NUMBER
)
SELECT 
    ROLE_TYPE,
    COUNT(*) as ASV_ACCOUNT_PAIRS,
    AVG(UNIQUE_RESOURCES) as AVG_UNIQUE_RESOURCES,
    AVG(TOTAL_INVENTORY) as AVG_INVENTORY,
    AVG(ROW_COUNT) as AVG_ROWS_PER_GROUP
FROM RoleComparison
GROUP BY ROLE_TYPE;

WITH FilterAnalysis AS (
    SELECT 
        ROLE_TYPE,
        COUNT(DISTINCT CONTROL_ID) as UNIQUE_CONTROLS,
        COUNT(DISTINCT CASE WHEN ESCALATING THEN CONTROL_ID END) as ESCALATING_CONTROLS,
        COUNT(DISTINCT CASE WHEN PHASE = 'OPERATIONAL' THEN CONTROL_ID END) as OPERATIONAL_CONTROLS
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 TC
    JOIN CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LC 
        ON TC.CONTROL_ID = LC.CONTROL_ID 
        AND TC.BATCH_ID = LC.BATCH_ID
    WHERE TC.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND TC.RESOURCE_TYPE = 'AWS::IAM::Role'
    AND TC.ROLE_TYPE IN ('MACHINE', 'N/A')
    GROUP BY ROLE_TYPE
)
SELECT * FROM FilterAnalysis;

WITH ResourceIdentification AS (
    SELECT 
        ROLE_TYPE,
        COUNT(DISTINCT RESOURCE_ID) as UNIQUE_RESOURCES,
        COUNT(DISTINCT CASE WHEN TOTAL_EVALUATIONS_COUNT > 0 THEN RESOURCE_ID END) as EVALUATED_RESOURCES,
        COUNT(DISTINCT CASE WHEN INVENTORY_COUNT > 0 THEN RESOURCE_ID END) as INVENTORIED_RESOURCES,
        COUNT(DISTINCT CASE 
            WHEN TOTAL_EVALUATIONS_COUNT > INVENTORY_COUNT THEN RESOURCE_ID 
        END) as OVER_EVALUATED_RESOURCES
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, RESOURCE_ID ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE IN ('MACHINE', 'N/A')
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE
)
SELECT 
    *,
    ROUND(EVALUATED_RESOURCES * 100.0 / NULLIF(UNIQUE_RESOURCES, 0), 2) as EVALUATION_PERCENTAGE,
    ROUND(OVER_EVALUATED_RESOURCES * 100.0 / NULLIF(EVALUATED_RESOURCES, 0), 2) as OVER_EVALUATION_PERCENTAGE
FROM ResourceIdentification;
