WITH CERT_STATUS AS (
    SELECT
        SUM(CASE WHEN NOT_VALID_ATER_UTC_TIMESTAMP < LAST_USAGE_OBSERVATION_UTC_TIMESTAMP THEN 1 ELSE 0 END) AS EXPIRED_CERTS,
        SUM(CASE WHEN DATEDIFF('DAY', CURRENT_TIMESTAMP, NOT_VALID_ATER_UTC_TIMESTAMP) <= 30 AND NOT_VALID_ATER_UTC_TIMESTAMP >
        CURRENT_TIMESTAMP THEN 1 ELSE 0 END) AS EXPIRING_CERTS,
        COUNT(*) AS TOTAL_CERTS
        FROM CYBR_DB.PHDP_CYBR.CERTIFICATE_CATALOG_CERTIFICATE_USAGE
        WHERE CERTIFICATE_ARN LIKE '%ARN:AWS:ACM%'
        AND NOT_VALID_ATER_UTC_TIMESTAMP IS NOT NULL
        AND LAST_USAGE_OBSERVATION_UTC_TIMESTAMP >= DATEADD(DAY, -14, CURRENT_TIMESTAMP)
)
SELECT
    CURRENT_DATE AS DATE,
    'MNTR-1077188-T2' AS MONITORING_METRIC_NUMBER,
    CASE WHEN EXPIRED_CERTS > 0 THEN (EXPIRED_CERTS * 100.0 / TOTAL_CERTS)
    ELSE 0 END AS MONITORING_METRIC,
    CASE WHEN EXPIRED_CERTS > 0 THEN 'RED'
    ELSE 'GREEN' END AS COMPLIANCE_STATUS,
    EXPIRED_CERTS AS NUMERATOR,
    TOTAL_CERTS AS DENOMINATOR
    FROM CERT_STATUS;
