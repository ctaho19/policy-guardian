
WITH LAST_SCAN_DATE AS (
    SELECT MAX(METRIC_DATE) AS RECENT_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE METRIC_DATE BETWEEN DATEADD(DAY, -3, CURRENT_DATE) AND DATEADD(DAY, -2, CURRENT_DATE())
),
METRIC_CALCULATION AS (
    SELECT 
        LSD.RECENT_DATE,
        SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) AS NUMERATOR,
        SUM(TOTAL_CLOUDFRONTED_BUCKETS) AS DENOMINATOR,
        CAST(SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) AS FLOAT) / 
            NULLIF(CAST(SUM(TOTAL_CLOUDFRONTED_BUCKETS) AS FLOAT), 0) AS TIER_1_METRIC
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV 
    RIGHT JOIN LAST_SCAN_DATE LSD ON MMV.METRIC_DATE = LSD.RECENT_DATE
    GROUP BY LSD.RECENT_DATE
)
SELECT 
    RECENT_DATE AS DATE,
    'MNTR-1079134-T1' AS MONITORING_METRIC_NUMBER,
    ROUND(TIER_1_METRIC * 100, 2) AS MONITORING_METRIC,
    CASE 
        WHEN TIER_1_METRIC >= 0.9 THEN 'GREEN'
        WHEN TIER_1_METRIC > 0.8 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    NUMERATOR,
    DENOMINATOR
FROM METRIC_CALCULATION;
