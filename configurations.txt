-- Detailed analysis of resource counts
WITH LATEST_BATCH AS (
    SELECT MAX(BATCH_ID) AS BATCH_ID 
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
)
SELECT 
    ACCOUNT_NUMBER,
    REGION,
    ASV,
    RESOURCE_TYPE,
    COUNT(*) as row_count,
    MIN(TOTAL_EVALUATIONS_COUNT) as min_eval,
    MAX(TOTAL_EVALUATIONS_COUNT) as max_eval,
    SUM(TOTAL_EVALUATIONS_COUNT) as sum_eval,
    MIN(INVENTORY_COUNT) as min_inv,
    MAX(INVENTORY_COUNT) as max_inv,
    SUM(INVENTORY_COUNT) as sum_inv
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
WHERE BATCH_ID = (SELECT BATCH_ID FROM LATEST_BATCH)
AND CONTROL_ID = 'CM-6.AWS.63.v01'
AND RESOURCE_TYPE = 'AWS::EC2::Instance'
AND INVENTORY_COUNT >= 0
GROUP BY 
    ACCOUNT_NUMBER,
    REGION,
    ASV,
    RESOURCE_TYPE
HAVING sum_eval > 100  -- Let's look at accounts with high evaluation counts
ORDER BY sum_eval DESC
LIMIT 10;
