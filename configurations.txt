-- Query 1: Investigate evaluation patterns
WITH RoleTypeComparison AS (
    SELECT 
        ROLE_TYPE,
        COUNT(DISTINCT ACCOUNT_NUMBER) as UNIQUE_ACCOUNTS,
        COUNT(DISTINCT ASV) as UNIQUE_ASVS,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        ROUND(AVG(INVENTORY_COUNT), 2) as AVG_INVENTORY_PER_ROW,
        ROUND(AVG(TOTAL_EVALUATIONS_COUNT), 2) as AVG_EVALUATIONS_PER_ROW,
        COUNT(*) as ROW_COUNT
    FROM (
        SELECT *,
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND CLOUD_PROVIDER = 'AWS'
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE
)
SELECT *,
       ROUND((TOTAL_EVALUATIONS * 100.0 / NULLIF(TOTAL_INVENTORY, 0)), 2) as COVERAGE_PERCENTAGE
FROM RoleTypeComparison
ORDER BY COVERAGE_PERCENTAGE ASC;

-- Query 2: Investigate inventory counting methodology
WITH InventoryAnalysis AS (
    SELECT 
        ROLE_TYPE,
        ASV,
        COUNT(DISTINCT ACCOUNT_NUMBER) as UNIQUE_ACCOUNTS,
        COUNT(*) as RESOURCE_COUNT,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        ROUND(AVG(INVENTORY_COUNT), 2) as AVG_INVENTORY,
        MAX(INVENTORY_COUNT) as MAX_INVENTORY,
        MIN(INVENTORY_COUNT) as MIN_INVENTORY
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE, ASV
)
SELECT *
FROM InventoryAnalysis
WHERE TOTAL_INVENTORY > AVG_INVENTORY * 5  -- Looking for unusual inventory patterns
ORDER BY TOTAL_INVENTORY DESC;


How do the evaluation patterns differ between role types?
2. Is there a significant difference in the ratio of unique accounts to unique ASVs?
How does the average inventory per row compare across role types?
For Query 2, please tell me:
Are there any ASVs with unusually high inventory counts?
Is there a pattern in which role types show the most variance between MIN and MAX inventory?
Are there cases where the TOTAL_INVENTORY seems disproportionate to the RESOURCE_COUNT?
