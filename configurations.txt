WITH RoleTypeStats AS (
    SELECT 
        ROLE_TYPE,
        ASV,
        COUNT(DISTINCT ACCOUNT_NUMBER) as UNIQUE_ACCOUNTS,
        COUNT(*) as RESOURCE_COUNT,
        SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
        SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS,
        ROUND(SUM(TOTAL_EVALUATIONS_COUNT) * 100.0 / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as COVERAGE_PERCENTAGE,
        ROUND(AVG(INVENTORY_COUNT), 2) as AVG_INVENTORY_PER_RESOURCE,
        ROUND(AVG(TOTAL_EVALUATIONS_COUNT), 2) as AVG_EVALUATIONS_PER_RESOURCE
    FROM (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE ORDER BY BATCH_ID DESC) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CLOUD_PROVIDER = 'AWS'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND INVENTORY_COUNT > 0
    ) a
    WHERE rank = 1
    GROUP BY ROLE_TYPE, ASV
)
SELECT 
    ROLE_TYPE,
    COUNT(*) as TOTAL_ASVs,
    SUM(RESOURCE_COUNT) as TOTAL_RESOURCES,
    SUM(TOTAL_INVENTORY) as TOTAL_INVENTORY,
    SUM(TOTAL_EVALUATIONS) as TOTAL_EVALUATIONS,
    ROUND(SUM(TOTAL_EVALUATIONS) * 100.0 / NULLIF(SUM(TOTAL_INVENTORY), 0), 2) as OVERALL_COVERAGE,
    COUNT(CASE WHEN COVERAGE_PERCENTAGE < 20 THEN 1 END) as ASVs_UNDER_20_PCT,
    ROUND(AVG(CASE WHEN COVERAGE_PERCENTAGE < 20 THEN TOTAL_INVENTORY ELSE NULL END), 2) as AVG_INVENTORY_LOW_COVERAGE,
    ROUND(AVG(CASE WHEN COVERAGE_PERCENTAGE >= 80 THEN TOTAL_INVENTORY ELSE NULL END), 2) as AVG_INVENTORY_HIGH_COVERAGE
FROM RoleTypeStats
GROUP BY ROLE_TYPE
ORDER BY OVERALL_COVERAGE DESC;

1. How do the inventory counts differ between high and low coverage ASVs across role types?
2. Is there a correlation between number of ASVs and coverage percentage?
3. What percentage of each role type's ASVs fall into the low coverage category?
