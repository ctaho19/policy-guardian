-- Diagnostic query to understand resource and evaluation counts
SELECT 
    CONTROL_ID,
    RESOURCE_TYPE,
    ROLE_TYPE,
    COUNT(*) as ROW_COUNT,
    SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATED,
    SUM(TOTAL_EVALUATIONS_COUNT) / NULLIF(SUM(INVENTORY_COUNT), 0) * 100 as EVALUATION_PERCENTAGE
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
AND CONTROL_ID = 'CM-6.AWS.63.v01'
AND RESOURCE_TYPE = 'AWS::EC2::Instance'
GROUP BY 
    CONTROL_ID,
    RESOURCE_TYPE,
    ROLE_TYPE
ORDER BY TOTAL_INVENTORY DESC;
