WITH LATEST_SCAN_DATE AS (
    -- Get the most recent scan date
    SELECT MAX(METRIC_DATE) AS MOST_RECENT_SCAN_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
),
SCAN_INFO AS (
    SELECT
        COALESCE(SUM(MMV.TOTAL_BUCKETS_SCANNED_BY_MACIE), 0) AS TOTAL_SCANNED_BUCKETS,
        LSD.MOST_RECENT_SCAN_DATE AS SCAN_DATE_USED,
        CURRENT_DATE() AS CURRENT_DATE,
        CASE 
            WHEN LSD.MOST_RECENT_SCAN_DATE = CURRENT_DATE() THEN 'Current'
            ELSE 'Not Current'
        END AS SCAN_STATUS
    FROM LATEST_SCAN_DATE LSD
    LEFT JOIN CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV 
        ON MMV.METRIC_DATE = LSD.MOST_RECENT_SCAN_DATE
    GROUP BY 
        LSD.MOST_RECENT_SCAN_DATE,
        CURRENT_DATE()
)
SELECT
    TOTAL_SCANNED_BUCKETS,
    SCAN_DATE_USED,
    SCAN_STATUS
FROM SCAN_INFO;
