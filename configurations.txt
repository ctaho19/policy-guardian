-- Step 1: Verify base data exists
SELECT COUNT(*), MAX(BATCH_ID)
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
WHERE CLOUD_PROVIDER = 'AWS'
AND RESOURCE_TYPE = 'AWS::IAM::Role'
AND INVENTORY_COUNT > 0;

-- Step 2: Verify LAZER_CONTROLS join works
SELECT COUNT(DISTINCT RESOURCE_TYPE)
FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03 LCTRL
LEFT JOIN CLCN_DB.PHDP_CLOUD.LAZER_COMPONENTS_V03 LCOMP 
    USING (CLOUD_CONTROL_ID, BATCH_ID)
WHERE LCTRL.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.LAZER_CONTROLS_V03)
AND ESCALATING
AND PHASE = 'OPERATIONAL'
AND RESOURCE_TYPE NOT ILIKE '';

-- Step 3: Test simplified version of our query
SELECT 
    ROLE_TYPE,
    COUNT(*) as COUNT,
    SUM(INVENTORY_COUNT) as TOTAL_INVENTORY,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATIONS
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
AND CLOUD_PROVIDER = 'AWS'
AND RESOURCE_TYPE = 'AWS::IAM::Role'
AND INVENTORY_COUNT > 0
GROUP BY ROLE_TYPE;
