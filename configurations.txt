WITH NON_COMPLIANT_RESOURCES AS (
    SELECT 
        nc.ACCOUNT_ID,
        nc.REGION,
        nc.RESOURCE_TYPE,
        nc.RESOURCE_ID,
        nc.CONTROL_ID,
        nc.OPEN_DATE_UTC_TIMESTAMP,
        DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) as DAYS_OPEN
    FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01 nc
    WHERE nc.CONTROL_ID = 'AC-3.AWS.30.v02'
    AND nc.ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
    )
)
SELECT CASE 
    WHEN EXISTS (SELECT 1 FROM NON_COMPLIANT_RESOURCES) THEN
        (SELECT * FROM NON_COMPLIANT_RESOURCES ORDER BY DAYS_OPEN DESC)
    ELSE
        SELECT 
            'No non-compliant resources found' as ACCOUNT_ID,
            NULL as REGION,
            NULL as RESOURCE_TYPE,
            NULL as RESOURCE_ID,
            NULL as CONTROL_ID,
            NULL as OPEN_DATE_UTC_TIMESTAMP,
            NULL as DAYS_OPEN
END;
