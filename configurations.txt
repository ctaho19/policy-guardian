WITH LATEST_BATCHES AS (
    -- Get latest batch IDs for both Lazer datasets
    SELECT MAX(BATCH_ID) AS LAZER_BATCH_ID
    FROM CLCN_DB.PHDP_CLOUD.lazer_controls_v03
),

CONTROL_INFO AS (
    -- Get control metadata from Lazer
    SELECT 
        lc.CLOUD_CONTROL_VERSION_ID,
        lc.RISK_RATING,
        lc.EXTERNAL_REPORTING_STATUS
    FROM CLCN_DB.PHDP_CLOUD.lazer_controls_v03 lc
    WHERE lc.BATCH_ID = (SELECT LAZER_BATCH_ID FROM LATEST_BATCHES)
    AND lc.CLOUD_CONTROL_VERSION_ID = '<your_control_id>'
    AND lc.EXTERNAL_REPORTING_STATUS = 'Operational'
),

LATEST_INVENTORY AS (
    -- Get latest total resource count
    SELECT SUM(INVENTORY_COUNT) AS TOTAL_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V3 qer
    WHERE qer.BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V3
    )
    AND qer.CONTROL_ID = '<your_control_id>'
),

PAST_SLA_RESOURCES AS (
    -- Count resources past SLA based on risk level from TCRD view
    SELECT 
        COUNT(DISTINCT nc.RESOURCE_ID) AS PAST_SLA_COUNT
    FROM CLCN_DB.PHDP_CLOUD.OZONE_NON_COMPLIANT_RESOURCES_TCRD_VIEW_V01 nc
    WHERE nc.CONTROL_ID = '<your_control_id>'
    AND nc.ID NOT IN (
        SELECT ID 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_CLOSED_NON_COMPLIANT_RESOURCES_V04
    )
    AND CASE 
        WHEN DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 30 
            AND nc.CONTROL_RISK = 'High' THEN 'PAST DUE'
        WHEN DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 0 
            AND nc.CONTROL_RISK = 'Critical' THEN 'PAST DUE'
        WHEN DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 60 
            AND nc.CONTROL_RISK = 'Medium' THEN 'PAST DUE'
        WHEN DATEDIFF('days', nc.OPEN_DATE_UTC_TIMESTAMP, CURRENT_DATE) > 90 
            AND nc.CONTROL_RISK = 'Low' THEN 'PAST DUE'
        ELSE 'NOT PAST DUE'
    END = 'PAST DUE'
),

METRIC_CALCULATION AS (
    -- Calculate the past SLA percentage
    SELECT 
        CAST(COALESCE(PAST_SLA_COUNT, 0) AS DECIMAL(18,2)) AS PAST_SLA_COUNT,
        CAST(TOTAL_RESOURCES AS DECIMAL(18,2)) AS TOTAL_RESOURCES,
        CASE 
            WHEN COALESCE(PAST_SLA_COUNT, 0) = 0 THEN 100.0
            ELSE ROUND(100.0 * (1 - (CAST(PAST_SLA_COUNT AS DECIMAL(18,2)) / NULLIF(CAST(TOTAL_RESOURCES AS DECIMAL(18,2)), 0))), 2)
        END AS SLA_COMPLIANCE_RATE
    FROM PAST_SLA_RESOURCES
    CROSS JOIN LATEST_INVENTORY
)

SELECT 
    CURRENT_DATE AS DATE,
    'MNTR-XXXXX-T3' AS MONITORING_METRIC_NUMBER,
    SLA_COMPLIANCE_RATE AS MONITORING_METRIC,
    CASE 
        WHEN SLA_COMPLIANCE_RATE >= 95.0 THEN 'GREEN'
        WHEN SLA_COMPLIANCE_RATE >= 90.0 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    CAST((TOTAL_RESOURCES - PAST_SLA_COUNT) AS INTEGER) AS NUMERATOR,
    CAST(TOTAL_RESOURCES AS INTEGER) AS DENOMINATOR
FROM METRIC_CALCULATION;
