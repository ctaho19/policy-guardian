
    SELECT 
        METRIC_DATE,
        SF_LOAD_TIMESTAMP,
        -- Consider scan current if timestamp is from today or yesterday
        CASE 
            WHEN DATE(SF_LOAD_TIMESTAMP) >= DATEADD(DAY, -1, CURRENT_DATE()) THEN TRUE 
            ELSE FALSE 
        END AS IS_CURRENT,
        TOTAL_BUCKETS_SCANNED_BY_MACIE AS BUCKETS_SCANNED
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    -- Get the row with the most recent load timestamp
    WHERE SF_LOAD_TIMESTAMP = (
        SELECT MAX(SF_LOAD_TIMESTAMP) 
        FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    )
)
SELECT 
    CURRENT_DATE() AS DATE,
    'MNTR-1079134-T0' AS MONITORING_METRIC_NUMBER,
    CASE 
        WHEN IS_CURRENT = TRUE AND BUCKETS_SCANNED > 0 THEN 1
        ELSE 0
    END AS MONITORING_METRIC,
    CASE 
        WHEN IS_CURRENT = TRUE AND BUCKETS_SCANNED > 0 THEN 'GREEN'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    BUCKETS_SCANNED AS NUMERATOR,
    1 AS DENOMINATOR
FROM LATEST_SCAN_INFO;

-- Tier 0 Supporting Evidence
WITH LATEST_SCAN_INFO AS (
    SELECT
        METRIC_DATE,
        SF_LOAD_TIMESTAMP,
        TOTAL_BUCKETS_SCANNED_BY_MACIE AS TOTAL_SCANNED_BUCKETS,
        CASE 
            WHEN DATE(SF_LOAD_TIMESTAMP) >= DATEADD(DAY, -1, CURRENT_DATE()) THEN 'Current'
            ELSE 'Not Current'
        END AS SCAN_STATUS
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE SF_LOAD_TIMESTAMP = (
        SELECT MAX(SF_LOAD_TIMESTAMP) 
        FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    )
)
SELECT
    TOTAL_SCANNED_BUCKETS,
    METRIC_DATE AS SCAN_DATE_USED,
    SF_LOAD_TIMESTAMP AS LAST_UPDATED,
    SCAN_STATUS
FROM LATEST_SCAN_INFO;

-- Tier 1 (Completeness) Main Query
WITH LATEST_SCAN_INFO AS (
    SELECT 
        METRIC_DATE,
        SF_LOAD_TIMESTAMP,
        TOTAL_BUCKETS_SCANNED_BY_MACIE,
        TOTAL_CLOUDFRONTED_BUCKETS,
        CASE 
            WHEN DATE(SF_LOAD_TIMESTAMP) >= DATEADD(DAY, -1, CURRENT_DATE()) THEN TRUE 
            ELSE FALSE 
        END AS IS_CURRENT
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE SF_LOAD_TIMESTAMP = (
        SELECT MAX(SF_LOAD_TIMESTAMP) 
        FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    )
)
SELECT
    CURRENT_DATE() AS DATE,
    'MNTR-1079134-T1' AS MONITORING_METRIC_NUMBER,
    CASE 
        WHEN IS_CURRENT THEN 
            ROUND(100.0 * TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0), 2)
        ELSE 0
    END AS MONITORING_METRIC,
    CASE 
        WHEN NOT IS_CURRENT THEN 'RED'
        WHEN (TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0)) >= 0.9 THEN 'GREEN'
        WHEN (TOTAL_BUCKETS_SCANNED_BY_MACIE / NULLIF(TOTAL_CLOUDFRONTED_BUCKETS, 0)) >= 0.8 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    TOTAL_BUCKETS_SCANNED_BY_MACIE AS NUMERATOR,
    TOTAL_CLOUDFRONTED_BUCKETS AS DENOMINATOR
FROM LATEST_SCAN_INFO;

-- Tier 1 Supporting Evidence
WITH LATEST_SCAN_INFO AS (
    SELECT
        METRIC_DATE,
        SF_LOAD_TIMESTAMP,
        TOTAL_BUCKETS_SCANNED_BY_MACIE AS SCANNED_BUCKETS,
        TOTAL_CLOUDFRONTED_BUCKETS AS TOTAL_BUCKETS,
        CASE 
            WHEN DATE(SF_LOAD_TIMESTAMP) >= DATEADD(DAY, -1, CURRENT_DATE()) THEN 'Current'
            ELSE 'Not Current'
        END AS SCAN_STATUS
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    WHERE SF_LOAD_TIMESTAMP = (
        SELECT MAX(SF_LOAD_TIMESTAMP) 
        FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
    )
)
SELECT
    SCANNED_BUCKETS,
    TOTAL_BUCKETS,
    ROUND(100.0 * SCANNED_BUCKETS / NULLIF(TOTAL_BUCKETS, 0), 2) AS SCAN_PERCENTAGE,
    METRIC_DATE AS SCAN_DATE_USED,
    SF_LOAD_TIMESTAMP AS LAST_UPDATED,
    SCAN_STATUS
FROM LATEST_SCAN_INFO;
