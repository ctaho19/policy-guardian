-- Tier 1 (Completeness) Main Query
WITH LATEST_SCAN_DATE AS (
    SELECT MAX(METRIC_DATE) AS MOST_RECENT_SCAN_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
),
METRIC_CALCULATION AS (
    SELECT
        LSD.MOST_RECENT_SCAN_DATE AS DATE,
        CURRENT_DATE() AS CURRENT_DATE,
        COALESCE(
            CAST(SUM(TOTAL_BUCKETS_SCANNED_BY_MACIE) AS FLOAT) /
            NULLIF(CAST(SUM(TOTAL_CLOUDFRONTED_BUCKETS) AS FLOAT), 0),
            0
        ) AS TIER_1_METRIC,
        CASE 
            WHEN LSD.MOST_RECENT_SCAN_DATE = CURRENT_DATE() THEN TRUE 
            ELSE FALSE 
        END AS IS_CURRENT
    FROM LATEST_SCAN_DATE LSD
    LEFT JOIN CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV 
        ON MMV.METRIC_DATE = LSD.MOST_RECENT_SCAN_DATE
    GROUP BY 
        LSD.MOST_RECENT_SCAN_DATE,
        CURRENT_DATE()
)
SELECT
    DATE,
    'MNTR-1079134-T1' AS MONITORING_METRIC_NUMBER,
    ROUND(TIER_1_METRIC * 100, 2) AS MONITORING_METRIC,
    CASE 
        WHEN NOT IS_CURRENT THEN 'RED'
        WHEN TIER_1_METRIC >= 0.9 THEN 'GREEN'
        WHEN TIER_1_METRIC >= 0.8 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS
FROM METRIC_CALCULATION;

-- Tier 1 Supporting Evidence Query
WITH LATEST_SCAN_DATE AS (
    SELECT MAX(METRIC_DATE) AS MOST_RECENT_SCAN_DATE
    FROM CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3
),
SCAN_INFO AS (
    SELECT
        COALESCE(SUM(MMV.TOTAL_BUCKETS_SCANNED_BY_MACIE), 0) AS SCANNED_BUCKETS,
        COALESCE(SUM(MMV.TOTAL_CLOUDFRONTED_BUCKETS), 0) AS TOTAL_BUCKETS,
        LSD.MOST_RECENT_SCAN_DATE AS SCAN_DATE_USED,
        CURRENT_DATE() AS CURRENT_DATE,
        CASE 
            WHEN LSD.MOST_RECENT_SCAN_DATE = CURRENT_DATE() THEN 'Current'
            ELSE 'Not Current'
        END AS SCAN_STATUS
    FROM LATEST_SCAN_DATE LSD
    LEFT JOIN CYBR_DB.PHDP_CYBR.MACIE_METRICS_V3 MMV 
        ON MMV.METRIC_DATE = LSD.MOST_RECENT_SCAN_DATE
    GROUP BY 
        LSD.MOST_RECENT_SCAN_DATE,
        CURRENT_DATE()
)
SELECT
    SCANNED_BUCKETS,
    TOTAL_BUCKETS,
    ROUND(100.0 * SCANNED_BUCKETS / NULLIF(TOTAL_BUCKETS, 0), 2) AS SCAN_PERCENTAGE,
    SCAN_DATE_USED,
    SCAN_STATUS
FROM SCAN_INFO;
