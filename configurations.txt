-- Side-by-side comparison of both approaches
WITH CORRECT_QUERY AS (
    -- This is the query we know works correctly
    SELECT 
        'CORRECT' as METHOD,
        COUNT(*) as RECORD_COUNT,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND CONTROL_ID = 'AC-3.AWS.30.v02'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND ROLE_TYPE = 'MACHINE'
),
RANKED_APPROACH AS (
    -- This is how RANKEDRECORDS is doing it
    SELECT 
        'RANKED' as METHOD,
        COUNT(*) as RECORD_COUNT,
        SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_RESOURCES
    FROM (
        SELECT *,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, ROLE_TYPE
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
        AND CONTROL_ID = 'AC-3.AWS.30.v02'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND ROLE_TYPE = 'MACHINE'
    ) r
    WHERE RANK = 1
),
DETAILED_COMPARISON AS (
    -- Look at specific differences in grouping
    SELECT 
        c.ACCOUNT_NUMBER,
        c.REGION,
        c.ASV,
        c.RESOURCE_TYPE,
        c.ROLE_TYPE,
        COUNT(*) as ROW_COUNT,
        SUM(c.INVENTORY_COUNT) as CORRECT_INVENTORY,
        SUM(c.TOTAL_EVALUATIONS_COUNT) as CORRECT_EVALUATED,
        MAX(CASE WHEN r.RANK = 1 THEN r.INVENTORY_COUNT END) as RANKED_INVENTORY,
        MAX(CASE WHEN r.RANK = 1 THEN r.TOTAL_EVALUATIONS_COUNT END) as RANKED_EVALUATED
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 c
    LEFT JOIN (
        SELECT *,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, ROLE_TYPE
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    ) r ON 
        c.ACCOUNT_NUMBER = r.ACCOUNT_NUMBER
        AND c.REGION = r.REGION
        AND c.ASV = r.ASV
        AND c.RESOURCE_TYPE = r.RESOURCE_TYPE
        AND c.ROLE_TYPE = r.ROLE_TYPE
    WHERE c.BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND c.CONTROL_ID = 'AC-3.AWS.30.v02'
    AND c.RESOURCE_TYPE = 'AWS::IAM::Role'
    AND c.ROLE_TYPE = 'MACHINE'
    GROUP BY 
        c.ACCOUNT_NUMBER,
        c.REGION,
        c.ASV,
        c.RESOURCE_TYPE,
        c.ROLE_TYPE
    HAVING SUM(c.INVENTORY_COUNT) != MAX(CASE WHEN r.RANK = 1 THEN r.INVENTORY_COUNT END)
        OR SUM(c.TOTAL_EVALUATIONS_COUNT) != MAX(CASE WHEN r.RANK = 1 THEN r.TOTAL_EVALUATIONS_COUNT END)
)

-- Show overall comparison
SELECT * FROM CORRECT_QUERY
UNION ALL
SELECT * FROM RANKED_APPROACH
ORDER BY METHOD;

-- Show sample of detailed differences
SELECT * FROM DETAILED_COMPARISON
ORDER BY ABS(CORRECT_INVENTORY - RANKED_INVENTORY) DESC
LIMIT 10;
