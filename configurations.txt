-- Detailed diagnostic query to understand the data distribution
WITH RANKEDRECORDS AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (
            PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE, RESOURCE_ID 
            ORDER BY BATCH_ID DESC
        ) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    )
    AND CONTROL_ID = 'CM-6.AWS.63.v01'
    AND RESOURCE_TYPE = 'AWS::EC2::Instance'
    AND INVENTORY_COUNT >= 0
)
SELECT 
    REGION,
    COUNT(*) as ROW_COUNT,
    SUM(INVENTORY_COUNT) as INVENTORY_COUNT,
    SUM(TOTAL_EVALUATIONS_COUNT) as EVALUATED_COUNT,
    COUNT(DISTINCT ACCOUNT_NUMBER) as UNIQUE_ACCOUNTS,
    COUNT(DISTINCT ASV) as UNIQUE_ASVS
FROM RANKEDRECORDS 
WHERE RANK = 1
GROUP BY REGION
ORDER BY INVENTORY_COUNT DESC;
GROUP BY 
    CONTROL_ID,
    RESOURCE_TYPE,
    ROLE_TYPE
ORDER BY TOTAL_INVENTORY DESC;
