WITH CERT_STATUS AS (
    SELECT
        SUM(CASE WHEN NOT_VALID_AFTER_UTC_TIMESTAMP < LAST_USAGE_OBSERVATION_UTC_TIMESTAMP THEN 1 ELSE 0 END) AS EXPIRED_CERTS,
        COUNT(*) AS TOTAL_CERTS
    FROM CYBR_DB.PHDP_CYBR.CERTIFICATE_CATALOG_CERTIFICATE_USAGE
    WHERE CERTIFICATE_ARN LIKE '%ARN:AWS:ACM%'
    AND NOT_VALID_AFTER_UTC_TIMESTAMP IS NOT NULL
    AND LAST_USAGE_OBSERVATION_UTC_TIMESTAMP >= DATEADD(YEAR, -1, CURRENT_TIMESTAMP)
)
SELECT
    CURRENT_DATE AS DATE,
    'MNTR-1077188-T2' AS MONITORING_METRIC_NUMBER,
    CASE WHEN EXPIRED_CERTS > 0 THEN ROUND((EXPIRED_CERTS * 100.0 / TOTAL_CERTS), 2)
    ELSE 0 END AS MONITORING_METRIC,
    CASE WHEN EXPIRED_CERTS > 0 THEN 'RED'
    ELSE 'GREEN' END AS COMPLIANCE_STATUS,
    EXPIRED_CERTS AS NUMERATOR,
    TOTAL_CERTS AS DENOMINATOR
FROM CERT_STATUS;
