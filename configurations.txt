-- Tier 1 with both explicit and Lazer mapping filters
WITH LATEST_BATCH AS (
    SELECT MAX(BATCH_ID) AS BATCH_ID 
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
),
VALID_RESOURCES AS (
    -- Get valid resource types from Lazer mapping
    SELECT DISTINCT RESOURCE_TYPE 
    FROM CLCN_DB.PHDP_CLOUD.LAZER_RESOURCE_TYPE_MAPPING_V01
    WHERE CONTROL_ID = 'CM-6.AWS.63.v01'
    AND BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.LAZER_RESOURCE_TYPE_MAPPING_V01
    )
    AND RESOURCE_TYPE = 'AWS::EC2::Instance'  -- Double-check resource type in Lazer
),
RANKEDRECORDS AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (
            PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
            ORDER BY BATCH_ID DESC
        ) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 t
    INNER JOIN VALID_RESOURCES v 
        ON t.RESOURCE_TYPE = v.RESOURCE_TYPE
    WHERE t.BATCH_ID = (SELECT BATCH_ID FROM LATEST_BATCH)
    AND t.CONTROL_ID = 'CM-6.AWS.63.v01'
    AND t.RESOURCE_TYPE = 'AWS::EC2::Instance'
    AND t.INVENTORY_COUNT >= 0
)
SELECT 
    SUM(INVENTORY_COUNT) as TOTAL_RESOURCES,
    SUM(TOTAL_EVALUATIONS_COUNT) as TOTAL_EVALUATED,
    ROUND(100.0 * SUM(TOTAL_EVALUATIONS_COUNT) / NULLIF(SUM(INVENTORY_COUNT), 0), 2) as EVALUATION_PERCENTAGE
FROM RANKEDRECORDS 
WHERE RANK = 1;
