-- DIAGNOSTIC QUERY 1: Validate join key relationship
WITH Violation_Resources AS (
    SELECT DISTINCT 
        v.RESOURCE_NAME AS violation_resource_name,
        r.RESOURCE_ID AS iam_resource_id
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 v
    LEFT JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_iam_resource r
        ON v.RESOURCE_NAME = r.AMAZON_RESOURCE_NAME
    WHERE v.ROLE_TYPE = 'MACHINE'
)
SELECT 
    COUNT(DISTINCT violation_resource_name) AS total_violation_names,
    COUNT(DISTINCT iam_resource_id) AS matched_iam_resources,
    COUNT(*) AS total_violation_records
FROM Violation_Resources;

-- DIAGNOSTIC QUERY 2: Identify unmatched violations
SELECT 
    v.RESOURCE_NAME,
    v.CONTROL_ID,
    v.EVALUATION_DATE
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 v
LEFT JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_iam_resource r
    ON v.RESOURCE_NAME = r.AMAZON_RESOURCE_NAME
WHERE v.ROLE_TYPE = 'MACHINE'
    AND r.RESOURCE_ID IS NULL
LIMIT 100;
