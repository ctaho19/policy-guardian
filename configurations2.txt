-- This query returns unmapped IAM roles (TYPE = 'role') from the resource stream dataset that are not present in the controls violations dataset for machine roles.

WITH Mapped_Violations AS (
    SELECT /*+ MATERIALIZE */
        DISTINCT RESOURCE_NAME
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
    WHERE ROLE_TYPE = 'MACHINE'
),
IAM_Roles AS (
    SELECT 
        RESOURCE_ID,
        AMAZON_RESOURCE_NAME,
        BA,
        ACCOUNT,
        CREATE_DATE
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE
    WHERE TYPE = 'role'
      AND AMAZON_RESOURCE_NAME LIKE 'arn:aws:iam::%role/%'  -- Filter for valid AWS role ARNs only
)
SELECT 
    r.RESOURCE_ID,
    r.AMAZON_RESOURCE_NAME,
    r.BA,
    r.ACCOUNT
FROM IAM_Roles r
WHERE NOT EXISTS (
    SELECT 1 
    FROM Mapped_Violations m
    WHERE m.RESOURCE_NAME = r.AMAZON_RESOURCE_NAME
)
QUALIFY ROW_NUMBER() OVER (
    PARTITION BY r.AMAZON_RESOURCE_NAME 
    ORDER BY r.CREATE_DATE DESC
) = 1;
