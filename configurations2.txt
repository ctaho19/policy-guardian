-- Tier 2 Metric for control 'CM-2.AWS.12.v02'
-- This metric calculates the percentage of evaluated AWS IAM MACHINE roles that are compliant.
-- Denom: The count of evaluated machine roles (i.e. from the controls violations for this control).
-- Numerator: The count of those evaluated roles whose COMPLIANCE_STATUS indicates compliance.
WITH 
  -- Select evaluated records for the given control from the controls violations dataset
  Evaluated AS (
      SELECT 
          RESOURCE_NAME,
          COMPLIANCE_STATUS,
          CREATE_DATE,
          ROW_NUMBER() OVER (PARTITION BY RESOURCE_NAME ORDER BY CREATE_DATE DESC) AS rn
      FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
      WHERE CONTROL_ID = 'CM-2.AWS.12.v02'
        AND ROLE_TYPE = 'MACHINE'
  ),
  -- Deduplicate so that each evaluated resource appears only once (latest record)
  Eval_Distinct AS (
      SELECT RESOURCE_NAME, COMPLIANCE_STATUS
      FROM Evaluated
      WHERE rn = 1
  ),
  -- Calculate the total evaluated count (denom) and the compliant count (numerator).
  Count_Calculations AS (
      SELECT
          COUNT(*) AS denominator,
          COUNT(CASE 
                    WHEN COMPLIANCE_STATUS IN (
                         'CompliantException',
                         'CompliantSuppression',
                         'Compliant',
                         'CompliantControlAllowance',
                         'CompliantPlatformException'
                    ) THEN 1 
                 END) AS numerator
      FROM Eval_Distinct
  ),
  Combined AS (
      SELECT
          denominator,
          numerator,
          CASE 
              WHEN denominator = 0 THEN 0 
              ELSE ROUND(100.0 * numerator / denominator, 2)
          END AS metric_value
      FROM Count_Calculations
  )
SELECT
    CURRENT_DATE() AS DATE,
    'MNTR-1071824-T2' AS MONITORING_METRIC_NUMBER,
    metric_value AS MONITORING_METRIC,
    CASE 
        WHEN metric_value >= 95 THEN 'GREEN'
        WHEN metric_value >= 85 THEN 'YELLOW'
        ELSE 'RED'
    END AS COMPLIANCE_STATUS,
    numerator AS NUMERATOR,
    denominator AS DENOMINATOR
FROM Combined;
