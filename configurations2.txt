WITH Random_Sample AS (
    SELECT 
        RESOURCE_ID,
        AMAZON_RESOURCE_NAME
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE
    WHERE TYPE = 'role'
    TABLESAMPLE BERNOULLI (0.1)  -- Random 0.1% sample (~1000 rows)
    LIMIT 1000  -- Hard cap for safety
)

SELECT 
    rs.AMAZON_RESOURCE_NAME,
    CASE 
        WHEN EXISTS (
            SELECT 1 
            FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 v
            WHERE v.RESOURCE_NAME = rs.AMAZON_RESOURCE_NAME
                AND v.ROLE_TYPE = 'MACHINE'
            LIMIT 1  -- Optimization for EXISTS
        ) THEN 'MACHINE' 
        ELSE 'OTHER' 
    END AS predicted_type
FROM Random_Sample rs;

WITH Recent_Violations AS (
    SELECT 
        COUNT(DISTINCT RESOURCE_NAME) AS distinct_machine_roles,
        COUNT(*) AS total_violations
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
    WHERE ROLE_TYPE = 'MACHINE'
        AND EVALUATION_DATE >= DATEADD(DAY, -30, CURRENT_DATE())
)

SELECT 
    distinct_machine_roles AS unique_machine_roles_in_violations,
    total_violations,
    (total_violations / NULLIF(distinct_machine_roles, 0))::FLOAT AS avg_violations_per_role
FROM Recent_Violations;
