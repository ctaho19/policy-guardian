-- Supporting Evidence Query for Tier 2 Metric for control 'CM-2.AWS.12.v02'
-- This query returns detailed information for evaluated AWS IAM MACHINE roles that are non-compliant.
-- If no such roles are found, a single row is returned stating "No non-compliant machine roles found".

WITH 
  -- Step 1: Get deduplicated evaluation records from the controls violations dataset for the control.
  Evaluated AS (
      SELECT 
          RESOURCE_NAME,
          COMPLIANCE_STATUS,
          CREATE_DATE,
          ROW_NUMBER() OVER (PARTITION BY RESOURCE_NAME ORDER BY CREATE_DATE DESC) AS rn
      FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
      WHERE CONTROL_ID = 'CM-2.AWS.12.v02'
        AND ROLE_TYPE = 'MACHINE'
  ),
  Eval_Distinct AS (
      SELECT RESOURCE_NAME, COMPLIANCE_STATUS, CREATE_DATE
      FROM Evaluated
      WHERE rn = 1
  ),
  -- Step 2: Get IAM role details from the resource stream (filtering to valid role ARNs).
  IAM_Roles AS (
      SELECT 
          RESOURCE_ID,
          AMAZON_RESOURCE_NAME,
          BA,
          ACCOUNT,
          CREATE_DATE
      FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE
      WHERE TYPE = 'role'
        AND AMAZON_RESOURCE_NAME LIKE 'arn:aws:iam::%role/%'
  ),
  Mapping AS (
      -- Deduplicate IAM resource rows by ARN, taking the most recent record per ARN.
      SELECT 
          r.RESOURCE_ID,
          r.AMAZON_RESOURCE_NAME,
          r.BA,
          r.ACCOUNT,
          r.CREATE_DATE AS IAM_CREATE_DATE
      FROM IAM_Roles r
      QUALIFY ROW_NUMBER() OVER (PARTITION BY r.AMAZON_RESOURCE_NAME ORDER BY r.CREATE_DATE DESC) = 1
  ),
  -- Step 3: Join the mapping with evaluated (deduplicated) records and filter for NonCompliant outcomes.
  NonCompliant AS (
      SELECT 
          m.RESOURCE_ID,
          m.AMAZON_RESOURCE_NAME,
          m.BA,
          m.ACCOUNT,
          e.CREATE_DATE,
          e.COMPLIANCE_STATUS
      FROM Mapping m
      INNER JOIN Eval_Distinct e
          ON m.AMAZON_RESOURCE_NAME = e.RESOURCE_NAME
      WHERE e.COMPLIANCE_STATUS = 'NonCompliant'
  )
  
-- Return non-compliant machine roles; if none exist, return a row stating so.
SELECT *
FROM NonCompliant

UNION ALL

SELECT 
    'N/A' AS RESOURCE_ID,
    'No non-compliant machine roles found' AS AMAZON_RESOURCE_NAME,
    NULL AS BA,
    NULL AS ACCOUNT,
    NULL AS CREATE_DATE,
    NULL AS COMPLIANCE_STATUS
WHERE NOT EXISTS (SELECT 1 FROM NonCompliant);
