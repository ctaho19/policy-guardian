WITH LATEST_TIMESTAMP AS (
    SELECT MAX(SF_LOAD_TIMESTAMP) AS LATEST_TS
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
),
BASE_RANKED_RECORDS AS (
    SELECT *,
    ROW_NUMBER() OVER (
        PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
        ORDER BY BATCH_ID DESC
    ) AS RANK
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE BATCH_ID = (SELECT MAX(BATCH_ID) FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
    AND CLOUD_PROVIDER = 'AWS'
    AND ROLE_TYPE IN ('', 'N/A', 'MACHINE')
    AND CONTROL_ID = '<your_control_id>'
    AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
),
INITIAL_COUNTS AS (
    SELECT 
        'Initial Data' as CHECK_POINT,
        COUNT(*) as RECORD_COUNT,
        COUNT(DISTINCT CONCAT(ASV, ACCOUNT_NUMBER, REGION, RESOURCE_TYPE)) as GROUP_COUNT,
        SUM(INVENTORY_COUNT) as INVENTORY_SUM,
        SUM(TOTAL_EVALUATIONS_COUNT) as EVAL_SUM
    FROM BASE_RANKED_RECORDS
    WHERE RANK = 1
),
COMPONENT_EVALUATIONS AS (
    SELECT 
        ASV,
        ACCOUNT_NUMBER,
        REGION,
        RESOURCE_TYPE,
        CONTROL_COMPONENT,
        COUNT(*) as RECORDS_PER_COMPONENT,
        SUM(TOTAL_EVALUATIONS_COUNT) as COMPONENT_EVAL_COUNT,
        SUM(INVENTORY_COUNT) as COMPONENT_INVENTORY
    FROM BASE_RANKED_RECORDS
    WHERE RANK = 1
    GROUP BY 
        ASV,
        ACCOUNT_NUMBER,
        REGION,
        RESOURCE_TYPE,
        CONTROL_COMPONENT
),
COMPONENT_STATS AS (
    SELECT 
        'Component Stats' as CHECK_POINT,
        COUNT(DISTINCT CONTROL_COMPONENT) as RECORD_COUNT,
        COUNT(DISTINCT CONCAT(ASV, ACCOUNT_NUMBER, REGION, RESOURCE_TYPE)) as GROUP_COUNT,
        SUM(COMPONENT_INVENTORY) as INVENTORY_SUM,
        SUM(COMPONENT_EVAL_COUNT) as EVAL_SUM
    FROM COMPONENT_EVALUATIONS
)
-- Show both summary statistics with matching columns
SELECT * FROM INITIAL_COUNTS
UNION ALL
SELECT * FROM COMPONENT_STATS;

-- Show detailed component breakdown separately
SELECT 
    ASV,
    ACCOUNT_NUMBER,
    REGION,
    RESOURCE_TYPE,
    CONTROL_COMPONENT,
    COMPONENT_EVAL_COUNT,
    COMPONENT_INVENTORY,
    RECORDS_PER_COMPONENT
FROM COMPONENT_EVALUATIONS
ORDER BY COMPONENT_EVAL_COUNT DESC
LIMIT 10;
