pipeline:
  name: pl_automated_monitoring_machine_iam
  use_test_data_on_nonprod: false
  dq_strict_mode: false

control_configs:
  - cloud_control_id: "AC-3.AWS.39.v02"
    ctrl_id: "CTRL-1074653"
    metric_ids:
      tier1: "MNTR-1074653-T1"
      tier2: "MNTR-1074653-T2"
      tier3: "MNTR-1074653-T3"
    requires_tier3: true
  - cloud_control_id: "AC-6.AWS.13.v01"
    ctrl_id: "CTRL-1105806"
    metric_ids:
      tier1: "MNTR-1105806-T1"
      tier2: "MNTR-1105806-T2"
    requires_tier3: false
  - cloud_control_id: "AC-6.AWS.35.v02"
    ctrl_id: "CTRL-1077124"
    metric_ids:
      tier1: "MNTR-1077124-T1"
      tier2: "MNTR-1077124-T2"
    requires_tier3: false

stages:
  extract:
    thresholds_raw:
      connector: snowflake
      options:
        sql: "@text:sql/monitoring_thresholds.sql"
    iam_roles:
      connector: snowflake
      options:
        sql: "@text:sql/iam_roles.sql"
    evaluated_roles:
      connector: snowflake
      options:
        sql: "@text:sql/evaluated_roles.sql"

  transform:
    monitoring_metrics:
      function: custom/calculate_machine_iam_metrics
      options:
        thresholds_raw: $thresholds_raw
        iam_roles: $iam_roles
        evaluated_roles: $evaluated_roles
        control_configs: $control_configs

  load:
    monitoring_metrics:
      connector: onestream
      options:
        table_name: etip_controls_monitoring_metrics
        file_type: AVRO
        avro_schema: "@json:avro_schema.json"
        business_application: BAENTERPRISETECHINSIGHTS

ingress_validation:
  thresholds_raw:
    - type: count_check
      fatal: true
      envs:
        - qa
        - prod
      options:
        data_location: Snowflake
        threshold: 1
        table_name: CYBR_DB_COLLAB.LAB_ESRA_TCRD.CYBER_CONTROLS_MONITORING_THRESHOLD
  iam_roles:
    - type: count_check
      fatal: true
      envs:
        - qa
        - prod
      options:
        data_location: Snowflake
        threshold: 1
        table_name: EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE_V3
        date_filter: "DATE(SF_LOAD_TIMESTAMP) = CURRENT_DATE"
  evaluated_roles:
    - type: count_check
      fatal: true
      envs:
        - qa
        - prod
      options:
        data_location: Snowflake
        threshold: 1
        table_name: EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
        date_filter: "DATE(CREATE_DATE) = CURRENT_DATE"

tags:
  - automated_monitoring
  - controls
  - machine_iam
  - cloud 
