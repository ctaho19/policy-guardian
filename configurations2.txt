-- Query 1: Check for mixed Role_Types within BA/Account combinations

WITH MACHINE_BA_ACCOUNT AS (
    SELECT DISTINCT ASV AS BA, ACCOUNT_NUMBER
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE ROLE_TYPE = 'MACHINE'
      AND RESOURCE_TYPE = 'AWS::IAM::Role'
),

IAM_ROLES_WITH_VIOLATIONS AS (
    SELECT iam.RESOURCE_ID, iam.BA, iam.ACCOUNT, viol.ROLE_TYPE
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
    LEFT JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 viol
        ON iam.AMAZON_RESOURCE_NAME = viol.RESOURCE_NAME
       AND viol.CONTROL_ID = 'CM-2.AWS.12.v02'
    WHERE iam.TYPE = 'role'
)

SELECT DISTINCT iam.BA, iam.ACCOUNT, iam.ROLE_TYPE
FROM IAM_ROLES_WITH_VIOLATIONS iam
JOIN MACHINE_BA_ACCOUNT mba
    ON iam.BA = mba.BA AND iam.ACCOUNT = mba.ACCOUNT_NUMBER
WHERE iam.ROLE_TYPE IS NOT NULL
ORDER BY iam.BA, iam.ACCOUNT, iam.ROLE_TYPE;

-- Query 2: Check the distribution of Role_Types in the Violations dataset

SELECT viol.ROLE_TYPE, COUNT(*) AS ROLE_COUNT
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 viol
WHERE viol.CONTROL_ID = 'CM-2.AWS.12.v02'
GROUP BY viol.ROLE_TYPE
ORDER BY ROLE_COUNT DESC;


-- Query 3: Identify BAs present in IAM_RESOURCES but missing in OZONE_DATA

SELECT DISTINCT iam.BA
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
WHERE iam.TYPE = 'role'
EXCEPT
SELECT DISTINCT ASV
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4;

-- Query 4: Compare the freshness of data between OZONE_DATA and IAM_RESOURCES

-- Get the latest BATCH_ID from OZONE_DATA
SELECT MAX(BATCH_ID) AS LATEST_OZONE_BATCH_ID
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4;

-- Get the latest UPDATE_DATE from IAM_RESOURCES
SELECT MAX(UPDATE_DATE) AS LATEST_IAM_UPDATE_DATE
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE
WHERE TYPE = 'role';

-- Query 5: Retrieve the APPLICABLE_AWS_ROLE_TYPES for the control from the metadata

SELECT
    CONTROL_ID,
    APPLICABLE_AWS_ROLE_TYPES,
    CONTROL_DESCRIPTION
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROL_METADATA_STREAM_1_V2
WHERE CONTROL_ID = 'CM-2.AWS.12.v02';


-- Query 6: Check if there are roles with the same BA and Account but different types

SELECT iam.BA, iam.ACCOUNT, iam.TYPE, COUNT(*) AS ROLE_COUNT
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
WHERE iam.TYPE = 'role'
GROUP BY iam.BA, iam.ACCOUNT, iam.TYPE
ORDER BY ROLE_COUNT DESC;
