WITH Recent_Control_Violations AS (
    SELECT /*+ MATERIALIZE */
        RESOURCE_NAME AS AMAZON_RESOURCE_NAME
    FROM 
        EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2
    WHERE 
        ROLE_TYPE = 'MACHINE'
        AND CONTROL_ID = 'CM-2.AWS.12.v02'  -- Specific control ID filter
        AND EVALUATION_DATE >= DATEADD(DAY, -90, CURRENT_DATE())  -- 90-day window
    GROUP BY 
        RESOURCE_NAME  -- Deduplicate at source
),

Filtered_IAM_Roles AS (
    SELECT 
        RESOURCE_ID,
        AMAZON_RESOURCE_NAME,
        BA,
        ACCOUNT
    FROM 
        EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE
    WHERE 
        TYPE = 'role'
        AND ACCOUNT IN (  -- Focus on specific accounts
            '123456789012', 
            '234567890123'
        )
        AND AMAZON_RESOURCE_NAME LIKE 'arn:aws:iam::%role/%'  -- AWS role pattern
    QUALIFY 
        ROW_NUMBER() OVER (
            PARTITION BY AMAZON_RESOURCE_NAME 
            ORDER BY LAST_MODIFIED_DATE DESC
        ) = 1  -- Get latest version of each role
)

SELECT 
    i.RESOURCE_ID,
    i.AMAZON_RESOURCE_NAME,
    i.BA,
    i.ACCOUNT,
    CASE 
        WHEN EXISTS (
            SELECT 1 
            FROM Recent_Control_Violations cv
            WHERE cv.AMAZON_RESOURCE_NAME = i.AMAZON_RESOURCE_NAME
        ) THEN 'MACHINE' 
        ELSE 'OTHER' 
    END AS ASSIGNED_ROLE_TYPE
FROM 
    Filtered_IAM_Roles i;
