WITH MACHINE_BA_ACCOUNT AS (
    SELECT DISTINCT ASV AS BA, ACCOUNT_NUMBER
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE ROLE_TYPE = 'MACHINE'
      AND RESOURCE_TYPE = 'AWS::IAM::Role'
),

IAM_MACHINE_ROLES AS (
    SELECT iam.RESOURCE_ID, iam.AMAZON_RESOURCE_NAME, iam.BA, iam.ACCOUNT
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
    INNER JOIN MACHINE_BA_ACCOUNT mba
        ON iam.BA = mba.BA
        AND iam.ACCOUNT = mba.ACCOUNT_NUMBER
    WHERE iam.TYPE = 'role'
)

SELECT COUNT(DISTINCT RESOURCE_ID) AS TOTAL_MACHINE_IAM_ROLES
FROM IAM_MACHINE_ROLES;

-- Step 1: Get the latest batch ID from the OZONE dataset
WITH LATEST_OZONE_BATCH AS (
    SELECT MAX(BATCH_ID) AS BATCH_ID
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
),

-- Step 2: Retrieve BA/Account combinations for Machine roles from the latest OZONE batch
MACHINE_BA_ACCOUNT AS (
    SELECT DISTINCT ozone.ASV AS BA, ozone.ACCOUNT_NUMBER
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 ozone
    INNER JOIN LATEST_OZONE_BATCH lob ON ozone.BATCH_ID = lob.BATCH_ID
    WHERE ozone.ROLE_TYPE = 'MACHINE'
      AND ozone.RESOURCE_TYPE = 'AWS::IAM::Role'
),

-- Step 3: Retrieve IAM Machine roles from the IAM Resources dataset updated on or after the latest OZONE batch date
IAM_MACHINE_ROLES AS (
    SELECT iam.RESOURCE_ID, iam.AMAZON_RESOURCE_NAME, iam.BA, iam.ACCOUNT
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
    INNER JOIN MACHINE_BA_ACCOUNT mba
        ON iam.BA = mba.BA
        AND iam.ACCOUNT = mba.ACCOUNT_NUMBER
    WHERE iam.TYPE = 'role'
      AND iam.UPDATE_DATE >= TO_DATE('2025-02-04', 'YYYY-MM-DD') -- Adjust date as per latest batch date
      AND iam.UPDATE_DATE < TO_DATE('2025-02-05', 'YYYY-MM-DD') -- Next day for exclusive upper bound
)

-- Final Step: Calculate the total number of Machine IAM Roles
SELECT COUNT(DISTINCT RESOURCE_ID) AS TOTAL_MACHINE_IAM_ROLES
FROM IAM_MACHINE_ROLES;
