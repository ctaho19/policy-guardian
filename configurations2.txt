-- Validate True Count of Machine IAM Roles:
SELECT COUNT(DISTINCT RESOURCE_ID) AS TRUE_MACHINE_ROLES
FROM IDENTITY_REPORTS_IAM_RESOURCE_STREAM
WHERE TYPE = 'AWS::IAM::Role'
AND ROLE_TYPE = 'MACHINE' 
AND ACCOUNT IN (SELECT ACCOUNT_NUMBER FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4);

--Identify Evaluation Coverage Gaps:
WITH TRUE_ROLES AS (
    SELECT RESOURCE_ID, AMAZON_RESOURCE_NAME
    FROM IDENTITY_REPORTS_IAM_RESOURCE_STREAM
    WHERE TYPE = 'AWS::IAM::Role' 
    AND ROLE_TYPE = 'MACHINE'
    AND ACCOUNT IN (SELECT ACCOUNT_NUMBER FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4)
),

EVALUATED_ROLES AS (
    SELECT DISTINCT RESOURCE_NAME 
    FROM (
        SELECT RESOURCE_NAME, BATCH_ID,
            ROW_NUMBER() OVER (
                PARTITION BY ACCOUNT_NUMBER, REGION, ASV, RESOURCE_TYPE 
                ORDER BY BATCH_ID DESC
            ) AS RANK
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE CONTROL_ID = 'CM-2.AWS.12.v02'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
        AND CLOUD_PROVIDER = 'AWS'
        AND ROLE_TYPE IN ('', 'N/A', 'MACHINE')
        AND INVENTORY_COUNT > 0
        AND LOWER(REGION) IN ('ca-central-1', 'eu-west-1', 'eu-west-2', 'us-east-1', 'us-east-2', 'us-west-2', 'global')
    ) ranked
    WHERE RANK = 1
)

SELECT 
    COUNT(tr.RESOURCE_ID) AS TOTAL_ROLES,
    COUNT(er.RESOURCE_NAME) AS EVALUATED_ROLES,
    COUNT(tr.RESOURCE_ID) - COUNT(er.RESOURCE_NAME) AS UNEVALUATED_GAP
FROM TRUE_ROLES tr
LEFT JOIN EVALUATED_ROLES er 
    ON tr.AMAZON_RESOURCE_NAME = er.RESOURCE_NAME;
    
-- Validate Control Scope:
SELECT APPLICABLE_AWS_ROLE_TYPES 
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROL_METADATA_STREAM_1_V2
WHERE CONTROL_ID = 'CM-2.AWS.12.v02';

-- Analyze Non-Evaluated Roles:
WITH NON_EVALUATED AS (
    SELECT iam.RESOURCE_ID, iam.AMAZON_RESOURCE_NAME
    FROM IDENTITY_REPORTS_IAM_RESOURCE_STREAM iam
    LEFT JOIN IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 eval
        ON iam.AMAZON_RESOURCE_NAME = eval.RESOURCE_NAME
    WHERE iam.TYPE = 'AWS::IAM::Role'
    AND iam.ROLE_TYPE = 'MACHINE'
    AND eval.RESOURCE_NAME IS NULL
)
SELECT 
    COUNT(*) AS NON_EVALUATED_COUNT,
    BA AS BUSINESS_ACCOUNT,
    REGION
FROM NON_EVALUATED
GROUP BY BA, REGION;
