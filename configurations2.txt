WITH OZONE_SUMMARY AS (
    SELECT 
        ASV AS BA,
        ACCOUNT_NUMBER,
        SUM(CASE 
            WHEN ROLE_TYPE = 'MACHINE' 
            AND RESOURCE_TYPE = 'AWS::IAM::Role' 
            AND INVENTORY_COUNT > 0
            AND CLOUD_PROVIDER = 'AWS'
            AND REGION = 'us-east-1'
            AND BATCH_ID = (
                SELECT MAX(BATCH_ID) 
                FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
            )
            THEN INVENTORY_COUNT 
            ELSE 0 
        END) AS TOTAL_RESOURCES,
        SUM(CASE 
            WHEN ROLE_TYPE = 'MACHINE' 
            AND RESOURCE_TYPE = 'AWS::IAM::Role' 
            AND INVENTORY_COUNT > 0
            AND CLOUD_PROVIDER = 'AWS'
            AND REGION = 'us-east-1'
            AND BATCH_ID = (
                SELECT MAX(BATCH_ID) 
                FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
            )
            THEN EVALUATIONS_COUNT 
            ELSE 0 
        END) AS EVALUATED_RESOURCES
    FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    WHERE ROLE_TYPE = 'MACHINE'
    AND RESOURCE_TYPE = 'AWS::IAM::Role'
    AND CLOUD_PROVIDER = 'AWS'
    AND CLOUD_REGION = 'us-east-1'
    AND BATCH_ID = (
        SELECT MAX(BATCH_ID) 
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
    )
    GROUP BY ASV, ACCOUNT_NUMBER
),
IAM_MACHINE_SUMMARY AS (
    SELECT 
        iam.BA,
        iam.ACCOUNT,
        COUNT(DISTINCT iam.RESOURCE_ID) AS IAM_MACHINE_ROLES
    FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
    JOIN (
        SELECT DISTINCT ASV AS BA, ACCOUNT_NUMBER
        FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4
        WHERE ROLE_TYPE = 'MACHINE'
        AND RESOURCE_TYPE = 'AWS::IAM::Role'
    ) mba 
    ON iam.BA = mba.BA
    AND iam.ACCOUNT = mba.ACCOUNT_NUMBER
    WHERE iam.TYPE = 'role'
    GROUP BY iam.BA, iam.ACCOUNT
)

SELECT 
    COALESCE(o.BA, i.BA) AS BA,
    COALESCE(o.ACCOUNT_NUMBER, i.ACCOUNT) AS ACCOUNT,
    o.TOTAL_RESOURCES AS OZONE_TOTAL,
    o.EVALUATED_RESOURCES AS OZONE_EVALUATED,
    i.IAM_MACHINE_ROLES AS IAM_COUNT,
    CASE 
        WHEN o.TOTAL_RESOURCES > i.IAM_MACHINE_ROLES THEN 'OZONE_HIGHER'
        WHEN o.TOTAL_RESOURCES < i.IAM_MACHINE_ROLES THEN 'IAM_HIGHER'
        ELSE 'EQUAL'
    END AS COMPARISON_RESULT,
    ABS(COALESCE(o.TOTAL_RESOURCES, 0) - COALESCE(i.IAM_MACHINE_ROLES, 0)) AS COUNT_DIFFERENCE
FROM OZONE_SUMMARY o
FULL OUTER JOIN IAM_MACHINE_SUMMARY i
    ON o.BA = i.BA 
    AND o.ACCOUNT_NUMBER = i.ACCOUNT
WHERE COALESCE(o.TOTAL_RESOURCES, 0) > 0 
   OR COALESCE(i.IAM_MACHINE_ROLES, 0) > 0
ORDER BY 
    COUNT_DIFFERENCE DESC,
    BA,
    ACCOUNT;
