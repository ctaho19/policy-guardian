-- Check for ASV values present in IAM data but missing in OZONE
SELECT DISTINCT iam.ASV
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
LEFT JOIN CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 ozone
    ON iam.ASV = ozone.ASV
    AND iam.ACCOUNT = ozone.ACCOUNT_NUMBER
WHERE ozone.ASV IS NULL
AND iam.TYPE = 'role';

-- Check for ASV values present in IAM data but missing in OZONE
SELECT DISTINCT iam.ASV
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam
LEFT JOIN CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 ozone
    ON iam.ASV = ozone.ASV
    AND iam.ACCOUNT = ozone.ACCOUNT_NUMBER
WHERE ozone.ASV IS NULL
AND iam.TYPE = 'role';

-- Compare OZONE's evaluation count with violation records
SELECT 
    ozone.TOTAL_EVALUATIONS_COUNT AS OZONE_COUNT,
    COUNT(DISTINCT viol.RESOURCE_NAME) AS VIOLATION_COUNT
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 ozone
LEFT JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 viol
    ON viol.CONTROL_ID = ozone.CONTROL_ID
    AND viol.RESOURCE_NAME IN (
        SELECT AMAZON_RESOURCE_NAME 
        FROM IDENTITY_REPORTS_IAM_RESOURCE 
        WHERE ASV = ozone.ASV 
        AND ACCOUNT = ozone.ACCOUNT_NUMBER
    )
WHERE ozone.CONTROL_ID = 'CM-2.AWS.12.v02'
GROUP BY 1;

-- Check if control metadata matches implementation
SELECT 
    meta.APPLICABLE_AWS_ROLE_TYPES,
    COUNT(DISTINCT viol.RESOURCE_NAME) AS EVALUATED_COUNT
FROM EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROL_METADATA_STREAM_1_V2 meta
LEFT JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_CONTROLS_VIOLATIONS_STREAM_V2 viol
    ON meta.CONTROL_ID = viol.CONTROL_ID
WHERE meta.CONTROL_ID = 'CM-2.AWS.12.v02'
GROUP BY 1;

-- Compare latest OZONE batch with IAM data timestamps
SELECT 
    MAX(ozone.BATCH_ID) AS LATEST_OZONE_BATCH,
    MAX(iam.UPDATE_DATE) AS LATEST_IAM_UPDATE
FROM CLCN_DB.PHDP_CLOUD.OZONE_QUARTERLY_EXAMINER_REVIEW_TOTAL_COUNTS_REPORT_V01_V4 ozone
CROSS JOIN EIAM_DB.PHDP_CYBR_IAM.IDENTITY_REPORTS_IAM_RESOURCE iam;

